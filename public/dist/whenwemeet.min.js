var wwm=function(){function e(e){wwm.model.initModule(),wwm.shell.initModule(e)}return{initModule:e}}();$(function(){var e="a35623411563ec424430d3bd5dc7a93e";$.ajaxSetup({cache:!0}),$.getScript("//connect.facebook.net/ko_KR/sdk.js",function(){FB.init({appId:"1617440885181938",xfbml:!0,version:"v2.4"})}),Kakao.init(e),wwm.initModule($("#whenwemeet"))}),wwm.model=function(){function e(e){var o=$.Deferred();return $.ajax("/join",{data:e,type:"post",contentType:"application/x-www-form-urlencoded;charset=utf-8"}).done(function(e){o.resolve(e)}).fail(function(e){o.reject(e)}),o.promise()}function o(e){var o=$.Deferred();return $.get("/rooms/"+e).done(function(e){0===e.length&&o.reject("no_room"),o.resolve(e)}).fail(function(e){o.reject(e)}),o.promise()}function n(e){var o=$.Deferred();return $.get("/search/"+e).done(function(e){0===e.length&&o.reject("no_room"),o.resolve(e)}).fail(function(e){o.reject(e)}),o.promise()}function i(e,o){var n=$.Deferred();return $.post("/ban/"+e,{rid:o}).done(function(e){console.log(e),n.resolve(e)}).fail(function(e){console.log(e),n.reject(e)}),n.promise()}function t(e,o){var n=$.Deferred();return $.post("/changeroom/"+e,{title:o}).done(function(e){console.log(e),n.resolve(e)}).fail(function(e){console.log(e),n.reject(e)}),n.promise()}function r(e,o){var n=$.Deferred();return $.post("/changeroom/"+e,{number:o}).done(function(e){console.log(e),n.resolve(e)}).fail(function(e){console.log(e),n.reject(e)}),n.promise()}function a(e){var o=$.Deferred(),n=e.rid;return $.post("/confirm/"+n,{day:e.day,night:e.night}).done(function(e){console.log(e),o.resolve(e)}).fail(function(e){console.log(e),o.reject(e)}),o.promise()}function l(e){var o=$.Deferred();return $.get("/member/"+e.maker).done(function(n){if(console.log(n),n[0].roomcount>=3){var i="방은 최대 세 개까지 만들 수 있습니다.";o.reject(i)}else $.post("/addroom/"+e.id,e).done(function(){o.resolve(n)}).fail(function(e){console.log(e),o.reject(e)})}).fail(function(e){console.log(e),o.reject(e)}),o.promise()}function s(e,o){var n=$.Deferred();return $.post("/deleteroom/"+e,{maker:o}).done(function(e){if(console.log(e),"no_room"===e){var o="심각한 오류! 방장이 아닙니다.";n.reject(o)}n.resolve(e)}).fail(function(e){n.reject(e)}),n.promise()}function d(){localStorage.login&&(window.userInfo=JSON.parse(localStorage.login))}return{initModule:d,createRoom:l,getRoomList:o,deleteRoom:s,ban:i,changeTitle:t,changeLimit:r,searchList:n,confirm:a,join:e}}(),wwm.shell=function(){function e(e){i={$con:e,$view:e.find("#view"),$modal:e.find("#modal"),$kakaoLogin:e.find("#kakao-login-btn"),$fbLogin:e.find("#fb-login-btn")}}function o(e,o,n,i,t){"string"==typeof e&&e.indexOf("Script error.")>-1||console.log("Error: ",e," Script: "+o+" Line: "+n+" Column: "+i+" StackTrace: "+t)}function n(n){console.log("login",localStorage.login),console.log("first",localStorage.first);var t=localStorage.login&&JSON.parse(localStorage.login),r=localStorage.first&&JSON.parse(localStorage.first);e(n),r&&wwm.modal.initModule($("#wwm-intro").html()),t?wwm.lobby.initModule(i.$view):wwm.login.initModule(i.$view),$(window).on("error",o)}var i;return{initModule:n}}(),wwm.lobby=function(){function e(){wwm.modal.initModule($("#wwm-createroom-modal").html())}function o(){var e=(new Spinner).spin();s.$list.append(e.el);var o=$(document.createDocumentFragment()),n=wwm.model.getRoomList(userInfo.id);n.done(function(e){console.log(e,e.length);for(var n=0;n<e.length;n++){var i=$("<div/>").addClass("title").text(e[n].title),t=$("<span/>").addClass("current").text(e[n].members.length),r=$("<span/>").addClass("total").text(e[n].number),a=$("<div/>").addClass("number").append(t).append("<span>/</span>").append(r),l=$("<div/>").addClass("room").attr({"data-rid":e[n].rid,"data-maker":e[n].maker,"data-member":e[n].members}).append(i).append(a);if(e[n].password){var d=$("<div/>").addClass("passwordroom").html("비번");l.prepend(d)}o.append(l)}s.$list.html(o)}),n.fail(function(e){return"no_room"===e?void s.$list.html("방이 없습니다. 방을 만들어보세요."):(console.log(e),void s.$list.html(e.responseText))}),n.always(function(){$(e.el).remove()})}function n(){var e=$(this).prev().val();console.log("query",e);var o=(new Spinner).spin();s.$list.append(o.el);var n=$(document.createDocumentFragment()),i=wwm.model.searchList(e);i.done(function(e){for(var o=0;o<e.length;o++){var i=$("<div/>").addClass("title").text(e[o].title),t=$("<span/>").addClass("current").text(e[o].members.length),r=$("<span/>").addClass("total").text(e[o].number),a=$("<div/>").addClass("number").append(t).append("<span>/</span>").append(r),l=$("<div/>").addClass("room").attr({"data-rid":e[o].rid,"data-maker":e[o].maker,"data-member":e[o].members}).append(i).append(a);if(e[o].password){var d=$("<div/>").addClass("passwordroom").html("비번");l.prepend(d)}n.append(l)}s.$list.html(n)}),i.fail(function(e){return"no_room"===e?void s.$list.html("검색 결과가 없습니다."):(console.log(e),void s.$list.html(e.responseText))}),i.always(function(){$(o.el).remove()})}function i(){delete window.userInfo,localStorage.removeItem("login"),localStorage.removeItem("loginType"),wwm.login.initModule(s.$con)}function t(){var e={rid:$(this).data("rid"),title:$(this).find(".title").text(),current:$(this).find(".current").text(),number:$(this).find(".total").text(),maker:$(this).data("maker"),member:JSON.parse($(this).data("member"))},o="",n=(new Spinner).spin();s.$list.append(n.el),$(this).has(".passwordroom").length&&(o=prompt("비밀번호")),$.post("/enterroom/"+e.rid,{pw:o,pid:userInfo.id}).done(function(o){console.log(o),e.day=o[0].day,e.night=o[0].night,wwm.room.initModule(e,"enter")}).fail(function(e){alert("비밀번호가 틀렸습니다.")}).always(function(){$(n.el).remove()})}function r(){o()}function a(e){s={$con:e,$showCreateroom:e.find("#show-createroom-modal"),$searchroomBtn:e.find("#searchroom-btn"),$list:e.find("#rooms"),$logout:e.find("#logout-btn"),$refresh:e.find("#refresh-list")}}function l(l){window.userInfo||(window.userInfo=JSON.parse(localStorage.login));var d=$("#wwm-lobby").text(),c=userInfo.name||userInfo.properties.nickname;dust.render(dust.loadSource(dust.compile(d)),{name:c},function(d,c){d?(console.log(d),alert("rendering error! 콘솔 확인")):(l.html(c),a(l),o(),s.$showCreateroom.click(e),s.$searchroomBtn.click(n),s.$logout.click(i),s.$refresh.click(r),$(document).on("click",".room",t))})}var s;return{initModule:l}}(),wwm.login=function(){function e(){var e={id:"123456789",name:"관리자"},o=wwm.model.join(e);o.fail(function(e){alert("가입 오류 발생!"),console.log(e.responseText)}),window.userInfo=e,localStorage.login=JSON.stringify(e),localStorage.loginType="localhost",wwm.lobby.initModule(a.$con)}function o(){var e={id:"987654321",name:"테스터"},o=wwm.model.join(e);o.fail(function(e){alert("가입 오류 발생!"),console.log(e.responseText)}),window.userInfo=e,localStorage.login=JSON.stringify(e),localStorage.loginType="localhost",wwm.lobby.initModule(a.$con)}function n(){Kakao.Auth.login({success:function(){Kakao.API.request({url:"/v1/user/me",success:function(e){var o=e.id,n=e.properties.nickname,i={name:n,id:o},t=wwm.model.join(i);t.fail(function(e){alert("가입 오류 발생!"),console.log(e.responseText)}),window.userInfo=e,localStorage.login=JSON.stringify(e),localStorage.loginType="kakao",wwm.lobby.initModule(a.$con)},fail:function(e){alert(JSON.stringify(e))}})},fail:function(e){alert(JSON.stringify(e))}})}function i(){FB.login(function(e){"connected"===e.status?FB.api("/me",function(e){var o=e.id,n=e.name,i={name:n,id:o},t=wwm.model.join(i);t.fail(function(e){alert("가입 오류 발생!"),console.log(e.responseText)}),window.userInfo=e,localStorage.login=JSON.stringify(e),localStorage.loginType="facebook",wwm.lobby.initModule(a.$con)}):alert("not_authorized"===e.status?"Please log log into this app.":"Please log into Facebook.")})}function t(e){a={$con:e,$kakaoLogin:e.find("#kakao-login-btn"),$fbLogin:e.find("#fb-login-btn"),$localhost:e.find("#localhost-login"),$localhost2:e.find("#localhost2-login"),$canvas:e.find("#canvas-logo")}}function r(r){r.html($("#wwm-login").html()),t(r);var l=a.$canvas[0].getContext("2d"),s=new Path2D;s.arc(75,75,50,0,2*Math.PI,!0),s.moveTo(110,75),s.arc(75,75,35,0,Math.PI,!1),s.moveTo(65,65),s.arc(60,65,5,0,2*Math.PI,!0),s.moveTo(95,65),s.arc(90,65,5,0,2*Math.PI,!0),l.stroke(s),a.$kakaoLogin.on({click:n,mouseover:function(){this.src="/kakao_account_login_btn_medium_narrow_ov.png"},mouseout:function(){this.src="/kakao_account_login_btn_medium_narrow.png"}}),a.$fbLogin.on({click:i,mouseover:function(){this.src="/facebook_ov.png"},mouseout:function(){this.src="/facebook.png"}}),a.$localhost.click(e),a.$localhost2.click(o)}var a;return{initModule:r}}(),wwm.modal=function(){function e(e){t={$con:e,$close:e.find(".modal-close"),$title:e.find("#room-title"),$number:e.find("#room-people-number"),$password:e.find("#room-password"),$createRoom:e.find("#create-room-btn")}}function o(){r.$modal.hide()}function n(){var e=(new Spinner).spin();t.$con.append(e.el);var o,n=t.$title.val(),i=t.$number.val(),a=t.$password.val(),l=JSON.parse(localStorage.login),s=l.id||l._id;if(!n)return $(e.el).remove(),void alert("제목을 입력하세요.");o={id:(new Date).getTime().toString(),title:n,maker:s,number:i,password:a||null};var d=wwm.model.createRoom(o);d.done(function(e){console.log(e),o.current=1,o.member=[o.id],wwm.room.initModule(o,"create"),r.$modal.hide()}),d.fail(function(e){alert(e)}),d.always(function(){$(e.el).remove()})}function i(i){r.$modal.html(i),e(r.$modal),t.$close.click(o),r.$modal.show(),t.$createRoom.click(n)}var t,r={$modal:$("#modal")};return{initModule:i}}(),wwm.room=function(){function o(e){C={$con:e,$explode:e.find("#explode-room"),$ban:e.find("#ban-people-btn"),$changeLimit:e.find("#change-number-btn"),$changeTitle:e.find("#change-room-title"),$calendar:e.find("table"),$thDay:e.find("table").find("tr").eq(0).find("th"),$thTime:e.find("table").find("tr").first(),$memberList:e.find("#member-list"),$day:e.find("#day"),$night:e.find("#night"),$back:e.find("#room-back"),$dayExp:e.find("#day-exception"),$notDay:e.find("#day-exception").find("li"),$timeExp:e.find("#time-exception"),$notTime:e.find("#time-exception").find("li"),$title:e.find("#title"),$total:e.find("#total-number"),$sendChat:e.find("#send-chat"),$chatList:e.find("#chat-list"),$confirm:e.find("#confirm-calendar"),$refresh:e.find("#refresh-calendar")}}function n(e){var o=new Array(e||0),i=e,t=0;if(arguments.length>1)for(var r=Array.prototype.slice.call(arguments,1);i--;)o[e-1-i]=n.apply(this,r);if(1==arguments.length)for(t;t<o.length;t++)o[t]=0;return o}function i(e,o){var n=[];console.log("cellList.length",e.length);for(var i=0;i<e.length;i++){var t=e[i],r=[t.parentNode.rowIndex-1,t.cellIndex-1];console.log(r);var a;if("day"===L.current)if(a=L.dayArray[r[0]][r[1]],o)console.log("busy:stMap.dayArray[arr[0]][arr[1]]",a),a?a.push(L.personColor):a=[L.personColor],console.log("cellresult",a),$(t).addClass("busy");else{console.log("not-busy:stMap.dayArray[arr[0]][arr[1]]",a);var l=a.indexOf(L.personColor);l>-1&&a.splice(l,1),$(t).removeClass("busy")}else if(a=L.nightArray[r[0]][r[1]],o)console.log("busy:stMap.nightArray[arr[0]][arr[1]]",a),a?a.push(L.personColor):a=[L.personColor],$(t).addClass("busy");else{console.log("not-busy:stMap.nightArray[arr[0]][arr[1]]",a);var l=a.indexOf(L.personColor);l>-1&&a.splice(l,1),$(t).removeClass("busy")}L.dayArray[r[0]][r[1]]=a,n.push(r)}return console.log("arrList",n),n}function t(e,o){if(console.log(e,o),"day"===L.current)for(var n=0;n<e.length;n++){var i=e[n],t=C.$calendar.find("tr").eq(i[0]+1).find("td").eq(i[1]),r=parseInt(t.attr("data-number"),10)||0,a=L.dayArray[i[0]][i[1]];if(o){r+=1,t.attr("data-number",r),t.find("div").remove();for(var l=$("<div/>").addClass("box-"+r),s=0;r>s;s++)l.append($("<div/>",{"class":S.colorList[a[s]-1]}));l.appendTo(t)}else{r-=1,t.attr("data-number",r),t.find("div").remove();for(var l=$("<div/>").addClass("box-"+r),s=0;r>s;s++)l.append($("<div/>",{"class":S.colorList[a[s]-1]}));l.appendTo(t)}console.log(t)}else"night"===L.current}function r(e){var o,n,i;if("day"===e)for(o=0;12>o;o++)for(n=0;7>n;n++){var t=C.$calendar.find("tr").eq(o+1).find("td").eq(n),r=t.data("number")||0,a=L.dayArray[o][n];if(console.log(t,r,a),a&&a.length>0){console.log("stMap.dayArray[i][j]",a),console.log("number",r);var l=$("<div/>").addClass("box-"+r);for(i=0;r>i;i++)l.append($("<div/>",{"class":S.colorList[a[i]-1]}));l.appendTo(t)}}else for(o=0;12>o;o++)for(n=0;7>n;n++){var t=C.$calendar.find("tr").eq(o).find("td").eq(n),r=t.data("number")||0;if(L.nightArray[o][n].length>0){console.log("stMap.nightArray[i][j]",L.nightArray[o][n]),console.log("number",r);var l=$("<div/>").addClass("box-"+r);for(i=0;r>i;i++)l.append($("<div/>",{"class":S.colorList[L.nightArray[o][n][i]-1]}));l.appendTo(t)}}}function a(e){console.log(e.id,-1==L.memberList.indexOf(e.id)),-1==L.memberList.indexOf(e.id)?(L.memberList.push(e.id),C.$memberList.find("ul").append('<li data-id="'+e.id+'"><span class="online">온라인</span>&nbsp;<span>'+e.name+"</span></li>")):C.$memberList.find("[data-id="+e.id+"]").find(".online").text("온라인")}function l(e){var o=wwm.model.ban(e.data.rid);o.done(function(e){}),o.fail(function(e){})}function s(e){var o=$(this).prev().val(),n=wwm.model.changeTitle(e.data.rid,o);n.done(function(e){C.$title.text(o)}),n.fail(function(e){alert("제목 바꾸기 실패!"),console.log(e)})}function d(e){var o=$(this).prev().val(),n=wwm.model.changeLimit(e.data.rid,o);n.done(function(e){C.$total.text(o)}),n.fail(function(e){alert("인원수 바꾸기 실패!"),console.log(e)})}function c(){var e=$(this);e.hasClass("opened")?(e.removeClass("opened"),e.find("ul").hide()):(e.addClass("opened"),e.find("ul").show())}function m(){var e=$(this);e.hasClass("opened")?(e.removeClass("opened"),e.find("ul").hide()):(e.addClass("opened"),e.find("ul").show())}function f(e){var o=e.data.rid,n=wwm.model.deleteRoom(o,userInfo.id);n.done(function(e){alert("삭제되었습니다."),wwm.lobby.initModule(C.$con)}),n.fail(function(e){console.log(e),alert("방 지우기 오류발생")})}function u(){$(this).hasClass("busy")?I.emit("not-busy",i([this],!1)):I.emit("busy",i([this],!0))}function g(e){e.stopPropagation(),alert($(this).index());for(var o=$(this).index(),n=[],i=0;12>i;i++)n.push([i,o]);$(this).hasClass("selected")?(I.emit("not-busy",n),$(this).removeClass("selected")):(I.emit("busy",n),$(this).addClass("selected"))}function p(){e.stopPropagation(),alert($(this).index());var o=$(this).index(),n=$(this).find("input").val();if(n){var i=[];if(0===o){for(var t=0;n>t;t++)for(var r=0;7>r;r++)i.push([n,r]);console.log("arr",i),$(this).hasClass("selected")?(I.emit("not-busy",i),$(this).removeClass("selected")):(I.emit("busy",i),$(this).addClass("selected"))}else{for(var t=n-1;12>t;t++)for(var r=0;7>r;r++)console.log(i),i.push([n,r]);console.log("arr",i),$(this).hasClass("selected")?(I.emit("not-busy",i),$(this).removeClass("selected")):(I.emit("busy",i),$(this).addClass("selected"))}}}function h(e){I.emit("out",{id:userInfo.id,rid:e.data.rid}),wwm.lobby.initModule(C.$con)}function v(){var e=$(this).prev("#chatbox").val();I.emit("chat",{id:userInfo.id,name:userInfo.name,text:e})}function w(e){$.post("/roominfo/"+L.rid).done(function(e){L.day=e[0].day?e[0].day:L.day,L.night=e[0].night?e[0].night:L.night,renderTalbe()}).fail(function(e){console.log(e),alert("새로고침 오류!")})}function b(e){var o=e.data;wwm.model.confirm(o)}function y(){L.current="day",r(L.current),C.$night.css("background","white"),C.$day.css("background","gray")}function k(){L.current="night",r(L.current),C.$day.css("background","white"),C.$night.css("background","gray")}function x(e,i){I.emit("enter",{id:userInfo.id,rid:e.rid,name:userInfo.name}),"create"===i?(L.dayArray=n(12,7),L.nightArray=n(12,7),console.log(L.dayArray,L.nightArray)):"enter"===i&&(L.dayArray=e.day||n(12,7),L.nightArray=e.night||n(12,7),console.log(L.dayArray,L.nightArray)),L.rid=e.rid,L.memberList=Array.isArray(e.member)?e.member:[e.member],console.log("doc.member",e.member),L.personColor=Array.isArray(e.member)?e.member.indexOf(userInfo.id)+1:1,console.log("stMap.personColor",L.personColor);var r={name:userInfo.name||userInfo.properties.nickname,title:e.title,current:e.current,total:e.number};console.log("userinfo.id",userInfo.id),console.log("doc.maker",e.maker),console.log("admin?",userInfo.id==e.maker),userInfo.id==e.maker&&(r.admin=!0),console.log("parser",r);var x=$("#wwm-room").text();dust.render(dust.loadSource(dust.compile(x)),r,function(n,i){return n?void S.$con.html(n):(S.$con.html(i),o(S.$con),C.$day.css({background:"gray"}),I.on("out",function(e){var o=L.onlineList.indexOf(e);L.onlineList.splice(o,1),console.log(C.$memberList,C.$memberList.find("[data-id="+e+"]")),C.$memberList.find("[data-id="+e+"]").find(".online").text("오프라인"),console.log("out",L.onlineList,L.memberList)}),I.on("quit",function(e){var o=L.onlineList.indexOf(e);L.onlineList.splice(o,1);var o=L.memberList.indexOf(e);L.memberList.splice(o,1),console.log(C.$memberList,C.$memberList.find("[data-id="+e+"]")),C.$memberList.find("[data-id="+e+"]").remove(),console.log("quit",L.onlineList,L.memberList)}),I.on("newMember",function(e){console.log("new member entered",e),a(e)}),I.on("chat",function(e){C.$chatList.text(e.name+" send: "+e.text)}),I.on("busy",function(e){console.log(e),t(e,!0)}),I.on("not-busy",function(e){console.log(e),t(e,!1)}),C.$calendar.find("td").click(u),C.$explode.click({id:e.rid},f),C.$back.click({rid:e.rid},h),C.$day.click(y),C.$night.click(k),C.$dayExp.click(c),C.$timeExp.click(m),C.$ban.click({id:e.rid},l),C.$changeLimit.click({id:e.rid},d),C.$changeTitle.click({id:e.rid},s),C.$sendChat.click(v),C.$notDay.click(g),C.$notTime.click(p),C.$confirm.click({rid:e.rid,day:L.dayArray,night:L.nightArray},b),void C.$refresh.click(w))})}var C,L={current:"day",dayArray:null,nightArray:null,memberList:[],onlineList:[],personColor:0,rid:null},S={$con:$("#view"),colorList:["red","orange","yellow","yellowgreen","skyblue","purple","violet","pink"]},I=io();return{initModule:x,info:L}}();