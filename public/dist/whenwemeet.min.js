var wwm=function(){function o(o){wwm.model.initModule(),wwm.shell.initModule(o)}return{initModule:o}}();$(function(){wwm.initModule($("#whenwemeet"))}),wwm.model=function(){function o(o){var n=$.Deferred();return o?$.get("/rooms/"+o).done(function(o){n.resolve(o)}).fail(function(o){n.reject(o)}):$.get("/rooms").done(function(o){n.resolve(o)}).fail(function(o){n.reject(o)}),n.promise()}function n(o){var n=$.Deferred();return $.get("/member/"+o.maker).done(function(o){if(o>3){var e="방은 최대 세 개까지 만들 수 있습니다.";n.reject(e)}}),$.post("/room/"+o.id,o).done(function(o){n.resolve(o)}),n.promise()}function e(){localStorage.login&&(window.userInfo=JSON.parse(localStorage.login))}return{initModule:e,createRoom:n,getRoomList:o}}(),wwm.shell=function(){function o(o){t={$con:o,$view:o.find("#view"),$modal:o.find("#modal"),$kakaoLogin:o.find("#kakao-login-btn"),$fbLogin:o.find("#fb-login-btn")}}function n(o,n,e,t,i){"string"==typeof o&&o.indexOf("Script error.")>-1||console.log("Error: ",o," Script: "+n+" Line: "+e+" Column: "+t+" StackTrace: "+i)}function e(e){$.ajaxSetup({cache:!0}),$.getScript("//connect.facebook.net/ko_KR/sdk.js",function(){FB.init({appId:"1617440885181938",xfbml:!0,version:"v2.4"})}),Kakao.init(i),console.log("login",localStorage.login),console.log("first",localStorage.first);{var l=localStorage.login&&JSON.parse(localStorage.login);localStorage.first&&JSON.parse(localStorage.first)}o(e),console.log("logged",l),l?wwm.lobby.initModule(t.$view):(e.find("#view").html($("#wwm-login").html()),o(e),t.$kakaoLogin.on({click:function(){Kakao.Auth.login({success:function(o){Kakao.API.request({url:"/v1/user/me",success:function(o){localStorage.login=JSON.stringify(o),localStorage.loginType="kakao",wwm.lobby.initModule(t.$view)},fail:function(o){alert(JSON.stringify(o))}})},fail:function(o){alert(JSON.stringify(o))}})},mouseover:function(){this.src="/kakao_account_login_btn_medium_narrow_ov.png"},mouseout:function(){this.src="/kakao_account_login_btn_medium_narrow.png"}}),t.$fbLogin.on({click:function(){FB.login(function(o){"connected"===o.status?FB.api("/me",function(o){localStorage.login=JSON.stringify(o),localStorage.loginType="facebook",wwm.lobby.initModule(t.$view)}):alert("not_authorized"===o.status?"Please log log into this app.":"Please log into Facebook.")})},mouseover:function(){this.src="/facebook_ov.png"},mouseout:function(){this.src="/facebook.png"}})),$(window).on("error",n)}var t,i="a35623411563ec424430d3bd5dc7a93e";return{initModule:e}}(),wwm.lobby=function(){function o(){wwm.modal.initModule($("#wwm-createroom-modal").html())}function n(){var o=(new Spinner).spin();c.$list.append(o.el);var n=($(document.createDocumentFragment()),wwm.model.getRoomList());n.done(function(o){console.log(o),c.$list.text(o)}),n.fail(function(o){console.log(o),c.$list.html(o.responseText)})}function e(o){var n=($(document.createDocumentFragment()),wwm.model.getRoomList(o));n.done(function(o){console.log(o),c.$list.text(o)}),n.fail(function(o){console.log(o),c.$list.html(o.responseText)})}function t(){localStorage.removeItem("login"),localStorage.removeItem("loginType"),wwm.lobby.initModule(c.$con)}function i(){wwm.room.initModule(c.$con,$(this))}function l(){n()}function r(o){c={$con:o,$showCreateroom:o.find("#show-createroom-modal"),$searchroomBtn:o.find("#searchroom-btn"),$list:o.find("#rooms"),$logout:o.find("#logout-btn"),$room:o.find(".room"),$refresh:o.find("#refresh-list")}}function a(a){var m=document.getElementById("wwm-lobby").textContent;u=JSON.parse(localStorage.login),console.log("lobby",localStorage.login);var s=u.properties.nickname||u.name;console.log("username",s),dust.render(dust.loadSource(dust.compile(m)),{name:s},function(u,m){u?(console.log(u),alert("error! �ܼ� Ȯ��")):(a.html(m),r(a),n(),c.$showCreateroom.click(o),c.$searchroomBtn.click(e),c.$logout.click(t),c.$room.click(i),c.$refresh.click(l))})}var c,u;return{initModule:a}}(),wwm.modal=function(){function o(o){i={$con:o,$close:o.find(".modal-close"),$title:o.find("#room-title"),$number:o.find("#room-people-number"),$password:o.find("#room-password"),$createRoom:o.find("#create-room-btn")}}function n(){l.$modal.hide()}function e(){var o=(new Spinner).spin();i.$con.append(o.el);var n,e=i.$title.val(),t=i.$number.val(),l=i.$password.val(),r=JSON.parse(localStorage.login),a=r.id||r._id;if(!e)return $(o.el).remove(),void alert("제목을 입력하세요.");n={id:String((new Date).getTime())+1e3*Math.random(),title:e,maker:a,number:t,password:l};var c=wwm.model.createRoom(n);c.done(function(n){$(o.el).remove(),wwm.room.initModule(n)}),c.fail(function(n){$(o.el).remove(),alert(n)})}function t(t){l.$modal.html(t),o(l.$modal),i.$close.click(n),l.$modal.show(),i.$createRoom.click(e)}var i,l={$modal:$("#modal")};return{initModule:t}}(),wwm.room=function(){function o(o){i={$con:o,$explode:o.find("#explode-room"),$ban:o.find("#ban-people-btn"),$changeNumber:o.find("#change-number-btn"),$changeTitle:o.find("#change-room-title"),$calendar:o.find("table")}}function n(){$(this).hasClass("busy")?(r.emit("not-busy",e(this)),$(this).removeClass("busy")):(r.emit("busy",e(this)),$(this).addClass("busy"))}function e(o){var n=[o.cellIndex,o.parentNode.rowIndex];return console.log("tableToArr",n),n}function t(e){l=JSON.parse(localStorage.login);var t=$("#wwm-room").text();dust.render(dust.loadSource(dust.compile(t)),{name:l.username},function(o,n){e.html(n)}),o(e),i.$calendar.find("td").click(n)}var i,l,r=io();return{initModule:t}}();