var wwm=function(){function e(e){wwm.model.initModule(),wwm.shell.initModule(e)}return{initModule:e}}();$(function(){var e="a35623411563ec424430d3bd5dc7a93e";$.ajaxSetup({cache:!0}),$.getScript("//connect.facebook.net/ko_KR/sdk.js",function(){FB.init({appId:"1617440885181938",xfbml:!0,version:"v2.4"})}),Kakao.init(e),wwm.initModule($("#whenwemeet"))}),wwm.model=function(){function e(e){var o=$.Deferred();return $.ajax("/join",{data:e,type:"post",contentType:"application/x-www-form-urlencoded;charset=utf-8"}).done(function(e){o.resolve(e)}).fail(function(e){o.reject(e)}),o.promise()}function o(e){var o=$.Deferred();return $.get("/rooms/"+e).done(function(e){0===e.length&&o.reject("no_room"),o.resolve(e)}).fail(function(e){o.reject(e)}),o.promise()}function n(e){var o=$.Deferred();return $.get("/search/"+e).done(function(e){0===e.length&&o.reject("no_room"),o.resolve(e)}).fail(function(e){o.reject(e)}),o.promise()}function i(e,o){var n=$.Deferred();return $.post("/ban/"+e,{rid:o}).done(function(e){console.log(e),n.resolve(e)}).fail(function(e){console.log(e),n.reject(e)}),n.promise()}function r(e,o){var n=$.Deferred();return $.post("/changeroom/"+e,{title:o}).done(function(e){console.log(e),n.resolve(e)}).fail(function(e){console.log(e),n.reject(e)}),n.promise()}function t(e,o){var n=$.Deferred();return $.post("/changeroom/"+e,{number:o}).done(function(e){console.log(e),n.resolve(e)}).fail(function(e){console.log(e),n.reject(e)}),n.promise()}function a(e){var o=$.Deferred(),n=e.rid;return $.post("/confirm/"+n,{day:e.day,night:e.night}).done(function(e){console.log(e),o.resolve(e)}).fail(function(e){console.log(e),o.reject(e)}),o.promise()}function l(e){var o=$.Deferred();return console.log("modeldata",e),$.get("/member/"+e.maker).done(function(n){if(console.log(n),n[0].roomcount>=3){var i="방은 최대 세 개까지 만들 수 있습니다.";o.reject(i)}else $.post("/addroom/"+e.rid,e).done(function(){o.resolve(n)}).fail(function(e){console.log(e),o.reject(e)})}).fail(function(e){console.log(e),o.reject(e)}),o.promise()}function s(e,o){var n=$.Deferred();return $.post("/deleteroom/"+e,{maker:o}).done(function(e){if(console.log(e),"no_room"===e){var o="심각한 오류! 방장이 아닙니다.";n.reject(o)}n.resolve(e)}).fail(function(e){n.reject(e)}),n.promise()}function d(){localStorage.login&&(window.userInfo=JSON.parse(localStorage.login))}return{initModule:d,createRoom:l,getRoomList:o,deleteRoom:s,ban:i,changeTitle:r,changeLimit:t,searchList:n,confirm:a,join:e}}(),wwm.shell=function(){function e(e){i={$con:e,$view:e.find("#view"),$modal:e.find("#modal"),$kakaoLogin:e.find("#kakao-login-btn"),$fbLogin:e.find("#fb-login-btn")}}function o(e,o,n,i,r){"string"==typeof e&&e.indexOf("Script error.")>-1||console.log("Error: ",e," Script: "+o+" Line: "+n+" Column: "+i+" StackTrace: "+r)}function n(n){console.log("login",localStorage.login),console.log("first",localStorage.first);var r=localStorage.login&&JSON.parse(localStorage.login),t=localStorage.first&&JSON.parse(localStorage.first);e(n),t&&wwm.modal.initModule($("#wwm-intro").html()),r?wwm.lobby.initModule(i.$view):wwm.login.initModule(i.$view),$(window).on("error",o)}var i;return{initModule:n}}(),wwm.lobby=function(){function e(){wwm.modal.initModule($("#wwm-createroom-modal").html())}function o(){var e=(new Spinner).spin();s.$list.append(e.el);var o=$(document.createDocumentFragment()),n=wwm.model.getRoomList(userInfo.id);n.done(function(e){for(var n=0;n<e.length;n++){var i=$("<div/>").addClass("title").text(e[n].title),r=$("<span/>").addClass("current").text(e[n].members.length),t=$("<span/>").addClass("total").text(e[n].number),a=$("<div/>").addClass("number").append(r).append("<span>/</span>").append(t),l=$("<div/>").addClass("room").attr({"data-rid":e[n].rid,"data-maker":e[n].maker,"data-members":JSON.stringify(e[n].members)}).append(i).append(a);if(e[n].password){var d=$("<div/>").addClass("passwordroom").html('<i class="fa fa-lock"></i>');l.prepend(d)}o.append(l)}s.$list.html(o)}),n.fail(function(e){return"no_room"===e?void s.$list.html("방이 없습니다. 방을 만들어보세요."):(console.log(e),void s.$list.html(e.responseText))}),n.always(function(){$(e.el).remove()})}function n(){var e=$(this).prev().val();console.log("query",e);var o=(new Spinner).spin();s.$list.append(o.el);var n=$(document.createDocumentFragment()),i=wwm.model.searchList(e);i.done(function(e){for(var o=0;o<e.length;o++){var i=$("<div/>").addClass("title").text(e[o].title),r=$("<span/>").addClass("current").text(e[o].members.length),t=$("<span/>").addClass("total").text(e[o].number),a=$("<div/>").addClass("number").append(r).append("<span>/</span>").append(t),l=$("<div/>").addClass("room").attr({"data-rid":e[o].rid,"data-maker":e[o].maker,"data-members":JSON.stringify(e[o].members)}).append(i).append(a);if(e[o].password){var d=$("<div/>").addClass("passwordroom").html('<i class="fa fa-lock"></i>');l.prepend(d)}n.append(l)}s.$list.html(n)}),i.fail(function(e){return"no_room"===e?void s.$list.html("검색 결과가 없습니다."):(console.log(e),void s.$list.html(e.responseText))}),i.always(function(){$(o.el).remove()})}function i(){delete window.userInfo,localStorage.removeItem("login"),localStorage.removeItem("loginType"),wwm.login.initModule(s.$con)}function r(){console.log($(this).data("members"));var e={rid:$(this).data("rid"),title:$(this).find(".title").text(),current:$(this).find(".current").text(),number:$(this).find(".total").text(),maker:$(this).data("maker"),members:$(this).data("members")},o="",n=(new Spinner).spin();s.$list.append(n.el),$(this).has(".passwordroom").length&&(o=prompt("비밀번호")),$.post("/enterroom/"+e.rid,{pw:o,pid:userInfo.id,name:userInfo.name}).done(function(o){console.log(o),e.day=o[0].day,e.night=o[0].night,wwm.room.initModule(e,"enter")}).fail(function(e){alert("비밀번호가 틀렸습니다.")}).always(function(){$(n.el).remove()})}function t(){o()}function a(e){s={$con:e,$showCreateroom:e.find("#show-createroom-modal"),$searchroomBtn:e.find("#searchroom-btn"),$list:e.find("#rooms"),$logout:e.find("#logout-btn"),$refresh:e.find("#refresh-list")}}function l(l){window.userInfo||(window.userInfo=JSON.parse(localStorage.login));var d=$("#wwm-lobby").text(),c=userInfo.name||userInfo.properties.nickname;dust.render(dust.loadSource(dust.compile(d)),{name:c},function(d,c){d?(console.log(d),alert("rendering error! 콘솔 확인")):(l.html(c),a(l),o(),s.$showCreateroom.click(e),s.$searchroomBtn.click(n),s.$logout.click(i),s.$refresh.click(t),$(document).on("click",".room",r))})}var s;return{initModule:l}}(),wwm.login=function(){function e(){var e={id:"123456789",name:"관리자"},o=wwm.model.join(e);o.fail(function(e){alert("가입 오류 발생!"),console.log(e.responseText)}),window.userInfo=e,localStorage.login=JSON.stringify(e),localStorage.loginType="localhost",wwm.lobby.initModule(a.$con)}function o(){var e={id:"987654321",name:"테스터"},o=wwm.model.join(e);o.fail(function(e){alert("가입 오류 발생!"),console.log(e.responseText)}),window.userInfo=e,localStorage.login=JSON.stringify(e),localStorage.loginType="localhost",wwm.lobby.initModule(a.$con)}function n(){Kakao.Auth.login({success:function(){Kakao.API.request({url:"/v1/user/me",success:function(e){var o=e.id,n=e.properties.nickname,i={name:n,id:o},r=wwm.model.join(i);r.fail(function(e){alert("가입 오류 발생!"),console.log(e.responseText)}),window.userInfo=e,localStorage.login=JSON.stringify(e),localStorage.loginType="kakao",wwm.lobby.initModule(a.$con)},fail:function(e){alert(JSON.stringify(e))}})},fail:function(e){alert(JSON.stringify(e))}})}function i(){FB.login(function(e){"connected"===e.status?FB.api("/me",function(e){var o=e.id,n=e.name,i={name:n,id:o},r=wwm.model.join(i);r.fail(function(e){alert("가입 오류 발생!"),console.log(e.responseText)}),window.userInfo=e,localStorage.login=JSON.stringify(e),localStorage.loginType="facebook",wwm.lobby.initModule(a.$con)}):alert("not_authorized"===e.status?"Please log log into this app.":"Please log into Facebook.")})}function r(e){a={$con:e,$kakaoLogin:e.find("#kakao-login-btn"),$fbLogin:e.find("#fb-login-btn"),$localhost:e.find("#localhost-login"),$localhost2:e.find("#localhost2-login"),$canvas:e.find("#canvas-logo")}}function t(t){t.html($("#wwm-login").html()),r(t);var l=a.$canvas[0].getContext("2d"),s=new Path2D;s.arc(75,75,50,0,2*Math.PI,!0),s.moveTo(110,75),s.arc(75,75,35,0,Math.PI,!1),s.moveTo(65,65),s.arc(60,65,5,0,2*Math.PI,!0),s.moveTo(95,65),s.arc(90,65,5,0,2*Math.PI,!0),l.stroke(s),a.$kakaoLogin.on({click:n,mouseover:function(){this.src="/kakao_account_login_btn_medium_narrow_ov.png"},mouseout:function(){this.src="/kakao_account_login_btn_medium_narrow.png"}}),a.$fbLogin.on({click:i,mouseover:function(){this.src="/facebook_ov.png"},mouseout:function(){this.src="/facebook.png"}}),a.$localhost.click(e),a.$localhost2.click(o)}var a;return{initModule:t}}(),wwm.modal=function(){function e(e){r={$con:e,$close:e.find(".modal-close"),$title:e.find("#room-title"),$number:e.find("#room-people-number"),$password:e.find("#room-password"),$createRoom:e.find("#create-room-btn")}}function o(){t.$modal.hide()}function n(){var e=(new Spinner).spin();r.$con.append(e.el);var o,n=r.$title.val(),i=r.$number.val(),a=r.$password.val(),l=JSON.parse(localStorage.login),s=l.id||l._id;if(!n)return $(e.el).remove(),void alert("제목을 입력하세요.");o={rid:(new Date).getTime().toString(),title:n,maker:s.toString(),number:i,password:a||null,members:JSON.stringify([{id:l.id,name:l.name}])},console.log("createroom data",o);var d=wwm.model.createRoom(o);d.done(function(e){console.log(e),o.current=1,wwm.room.initModule(o,"create"),t.$modal.hide()}),d.fail(function(e){console.log(e),alert("방 생성에러! 콘솔확인")}),d.always(function(){$(e.el).remove()})}function i(i){t.$modal.html(i),e(t.$modal),r.$close.click(o),t.$modal.show(),r.$createRoom.click(n)}var r,t={$modal:$("#modal")};return{initModule:i}}(),wwm.room=function(){function e(e){C={$con:e,$explode:e.find("#explode-room"),$ban:e.find("#ban-people-btn"),$changeLimit:e.find("#change-number-btn"),$changeTitle:e.find("#change-room-title"),$calendar:e.find("table"),$thDay:e.find("table").find("tr").eq(0).find("th"),$thTime:e.find("table").find("tr").first(),$memberList:e.find("#member-list"),$day:e.find("#day"),$night:e.find("#night"),$back:e.find("#room-back"),$admin:e.find("#admin-menu"),$dayExp:e.find("#day-exception"),$notDay:e.find("#day-exception").find("li"),$timeExp:e.find("#time-exception"),$notTime:e.find("#time-exception").find("li"),$title:e.find("#title"),$total:e.find("#total-number"),$sendChat:e.find("#send-chat"),$chatList:e.find("#chat-list"),$confirm:e.find("#confirm-calendar"),$refresh:e.find("#refresh-calendar")}}function o(e){var n=new Array(e||0),i=e,r=0;if(arguments.length>1)for(var t=Array.prototype.slice.call(arguments,1);i--;)n[e-1-i]=o.apply(this,t);if(1==arguments.length)for(r;r<n.length;r++)n[r]=[];return n}function n(e,o){for(var n=[],i=0;i<e.length;i++){var r=e[i],t=[r.parentNode.rowIndex-1,r.cellIndex-1];n.push(t)}return console.log("tableToArray",n),n}function i(e,o,n,i){if(console.log(e,o,n,S.current,i),n===S.current)if("day"===S.current){for(var r=0;r<e.length;r++){var t,a=e[r],l=C.$calendar.find("tr").eq(a[0]+1).find("td").eq(a[1]),s=S.dayArray[a[0]][a[1]];if(i){s.push(o),t=s.length,l.find("div").remove();for(var d=$("<div/>").addClass("box-"+t),c=0;t>c;c++)d.append($("<div/>",{"class":A.colorList[s[c]-1]}));d.appendTo(l)}else{var f=s.indexOf(o);f>-1&&s.splice(f,1),t=s.length,l.find("div").remove();for(var d=$("<div/>").addClass("box-"+t),c=0;t>c;c++)console.log(A.colorList[s[c]-1]),d.append($("<div/>",{"class":A.colorList[s[c]-1]}));d.appendTo(l)}S.dayArray[a[0]][a[1]]=s}console.log("arrToTable:day",S.dayArray,S.nightArray)}else{for(var r=0;r<e.length;r++){var t,a=e[r],l=C.$calendar.find("tr").eq(a[0]+1).find("td").eq(a[1]),m=S.nightArray[a[0]][a[1]];if(i){m.push(o),t=m.length,l.find("div").remove();for(var d=$("<div/>").addClass("box-"+t),c=0;t>c;c++)d.append($("<div/>",{"class":A.colorList[m[c]-1]}));d.appendTo(l)}else{var f=m.indexOf(o);f>-1&&m.splice(f,1),t=m.length,l.find("div").remove();for(var d=$("<div/>").addClass("box-"+t),c=0;t>c;c++)d.append($("<div/>",{"class":A.colorList[m[c]-1]}));d.appendTo(l)}S.nightArray[a[0]][a[1]]=m}console.log("arrToTable:night",S.dayArray,S.nightArray)}else if("day"===n)for(var r=0;r<e.length;r++){var a=e[r],s=S.dayArray[a[0]][a[1]];s.push(o),console.log("different day",s),S.dayArray[a[0]][a[1]]=s}else for(var r=0;r<e.length;r++){var a=e[r],m=S.nightArray[a[0]][a[1]];m.push(o),console.log("different night",m),S.nightArray[a[0]][a[1]]=m}}function r(e){var o,n,i;if("day"===e)for(console.log("renderTable:day",S.dayArray),o=0;12>o;o++)for(n=0;7>n;n++){var r=C.$calendar.find("tr").eq(o+1).find("td").eq(n),t=S.dayArray[o][n],a=t.length;if(r.find("div").remove(),a>0){var l=$("<div/>").addClass("box-"+a);for(i=0;a>i;i++)l.append($("<div/>",{"class":A.colorList[t[i]-1]}));l.appendTo(r)}}else for(console.log("renderTable:night",S.nightArray),o=0;12>o;o++)for(n=0;7>n;n++){var r=C.$calendar.find("tr").eq(o+1).find("td").eq(n),s=S.nightArray[o][n],a=s.length;if(r.find("div").remove(),a>0){var l=$("<div/>").addClass("box-"+a);for(i=0;a>i;i++)l.append($("<div/>",{"class":A.colorList[s[i]-1]}));l.appendTo(r)}}}function t(){console.log("showMembers",S.memberList);for(var e=0;e<S.memberList.length;e++)C.$memberList.find("ul").append('<li data-id="'+S.memberList[e].id+'"><span class="online">오프라인</span>&nbsp;<span>'+S.memberList[e].name+"</span></li>")}function a(e){console.log(e.id,S.memberList);for(var o=!1,n=0;n<S.memberList.length;n++)if(S.memberList[n].id==e.id){o=!0;break}console.log(o),o?C.$memberList.find("[data-id="+e.id+"]").find(".online").text("온라인"):C.$memberList.find("ul").append('<li data-id="'+e.id+'"><span class="online">온라인</span>&nbsp;<span>'+e.name+"</span></li>")}function l(e){var o=wwm.model.ban(e.data.rid);o.done(function(e){}),o.fail(function(e){})}function s(e){var o=$(this).prev().val(),n=wwm.model.changeTitle(e.data.rid,o);n.done(function(e){C.$title.text(o)}),n.fail(function(e){alert("제목 바꾸기 실패!"),console.log(e)})}function d(e){var o=$(this).prev().val(),n=wwm.model.changeLimit(e.data.rid,o);n.done(function(e){C.$total.text(o)}),n.fail(function(e){alert("인원수 바꾸기 실패!"),console.log(e)})}function c(){var e=$(this);e.hasClass("opened")?(e.removeClass("opened"),e.find("ul").hide()):(e.addClass("opened"),e.find("ul").show())}function f(){var e=$(this);e.hasClass("opened")?(e.removeClass("opened"),e.find("ul").hide()):(e.addClass("opened"),e.find("ul").show())}function m(){var e=$(this);e.hasClass("opened")?(e.removeClass("opened"),e.find("ul").hide()):(e.addClass("opened"),e.find("ul").show())}function u(e){var o=e.data.rid,n=wwm.model.deleteRoom(o,userInfo.id);n.done(function(e){alert("삭제되었습니다."),wwm.lobby.initModule(C.$con)}),n.fail(function(e){console.log(e),alert("방 지우기 오류발생")})}function g(){var e,o;"day"===S.current?e=S.dayArray:"night"===S.current&&(e=S.nightArray),o=e[this.parentNode.rowIndex-1][this.cellIndex-1],console.log("not-busy",o,o.length,S.personColor),o?(console.log(o.indexOf(S.personColor)>-1),o.length&&o.indexOf(S.personColor)>-1?T.emit("not-busy",{cur:S.current,sid:S.personColor,arr:n([this],!1)}):T.emit("busy",{cur:S.current,sid:S.personColor,arr:n([this],!0)})):T.emit("busy",{cur:S.current,sid:S.personColor,arr:n([this],!0)})}function p(e){e.stopPropagation(),alert($(this).index());for(var o=$(this).index(),n=[],i=0;12>i;i++)n.push([i,o]);$(this).hasClass("selected")?(T.emit("not-busy",n),$(this).removeClass("selected")):(T.emit("busy",n),$(this).addClass("selected"))}function h(e){e.stopPropagation(),alert($(this).index());var o=$(this).index(),n=$(this).find("input").val();if(n){var i=[];if(0===o){for(var r=0;n>r;r++)for(var t=0;7>t;t++)i.push([n,t]);console.log("arr",i),$(this).hasClass("selected")?(T.emit("not-busy",i),$(this).removeClass("selected")):(T.emit("busy",i),$(this).addClass("selected"))}else{for(var r=n-1;12>r;r++)for(var t=0;7>t;t++)console.log(i),i.push([n,t]);console.log("arr",i),$(this).hasClass("selected")?(T.emit("not-busy",i),$(this).removeClass("selected")):(T.emit("busy",i),$(this).addClass("selected"))}}}function v(e){T.emit("out",{id:userInfo.id,rid:e.data.rid}),wwm.lobby.initModule(C.$con)}function b(){var e=$(this).prev("#chatbox").val();T.emit("chat",{id:userInfo.id,name:userInfo.name,text:e})}function w(e){$.post("/roominfo/"+S.rid).done(function(e){S.day=e[0].day?e[0].day:S.day,S.night=e[0].night?e[0].night:S.night,r()}).fail(function(e){console.log(e),alert("새로고침 오류!")})}function y(e){var o=e.data;wwm.model.confirm(o)}function k(){S.current="day",r(S.current),C.$night.css("background","white"),C.$day.css("background","gray")}function x(){S.current="night",r(S.current),C.$day.css("background","white"),C.$night.css("background","gray")}function L(n,L){T.emit("enter",{id:userInfo.id,rid:n.rid,name:userInfo.name}),"create"===L?(S.dayArray=o(12,7),S.nightArray=o(12,7),console.log(S.dayArray,S.nightArray)):"enter"===L&&(S.dayArray=n.day||o(12,7),S.nightArray=n.night||o(12,7),console.log(S.dayArray,S.nightArray)),S.rid=n.rid,console.log("doc.members",n.members),S.memberList=Array.isArray(n.members)?n.members:JSON.parse(n.members);for(var I=0;I<n.members.length;I++)n.members[I].id==userInfo.id&&(S.personColor=I+1);console.log("stMap.personColor",S.personColor);var M={name:userInfo.name||userInfo.properties.nickname,title:n.title,current:n.current,total:n.number,members:S.memberList};userInfo.id==n.maker&&(M.admin=!0),console.log("admin?",userInfo.id==n.maker),console.log("parser",M);var j=$("#wwm-room").text(),O=dust.compile(j),_=dust.loadSource(O);dust.render(_,M,function(o,$){return o?void A.$con.html(o):(A.$con.html($),e(A.$con),C.$day.css({background:"gray"}),t(),T.on("out",function(e){var o=S.onlineList.indexOf(e);S.onlineList.splice(o,1),console.log(C.$memberList,C.$memberList.find("[data-id="+e+"]")),C.$memberList.find("[data-id="+e+"]").find(".online").text("오프라인"),console.log("out",S.onlineList,S.memberList)}),T.on("quit",function(e){var o=S.onlineList.indexOf(e);S.onlineList.splice(o,1);var o=S.memberList.indexOf(e);S.memberList.splice(o,1),console.log(C.$memberList,C.$memberList.find("[data-id="+e+"]")),C.$memberList.find("[data-id="+e+"]").remove(),console.log("quit",S.onlineList,S.memberList)}),T.on("newMember",function(e){console.log("new member entered",e),T.emit("uptodateArr",{sid:e.socket,day:S.dayArray,night:S.nightArray}),a(e)}),T.on("uptodateArr",function(e){console.log("info transferred"),S.dayArray=e.day,S.nightArray=e.night,r(S.current)}),T.on("chat",function(e){C.$chatList.append("<div>"+e.name+" send: "+e.text+"</div>")}),T.on("busy",function(e){console.log("socketbusy:",e.arr,e.sid,e.cur),i(e.arr,e.sid,e.cur,!0)}),T.on("not-busy",function(e){console.log("socketnotbusy:",e.arr,e.sid,e.cur),i(e.arr,e.sid,e.cur,!1)}),C.$calendar.find("td").click(g),C.$explode.click({id:n.rid},u),C.$back.click({rid:n.rid},v),C.$day.click(k),C.$night.click(x),C.$admin.click(c),C.$dayExp.click(f),C.$timeExp.click(m),C.$ban.click({id:n.rid},l),C.$changeLimit.click({id:n.rid},d),C.$changeTitle.click({id:n.rid},s),C.$sendChat.click(b),C.$notDay.click(p),C.$notTime.click(h),C.$confirm.click({rid:n.rid,day:S.dayArray,night:S.nightArray},y),void C.$refresh.click(w))})}var C,S={current:"day",dayArray:null,nightArray:null,memberList:[],onlineList:[],personColor:0,rid:null},A={$con:$("#view"),colorList:["red","orange","yellow","yellowgreen","skyblue","purple","violet","pink"]},T=io();return{initModule:L,info:S}}();