window.onerror=function(o,e,n,i,r){"string"==typeof o&&o.indexOf("Script error.")>-1||console.log("Error: ",o," Script: "+e+" Line: "+n+" Column: "+i+" StackTrace: "+r)},$.fn.showSVGLogo=function(o){var e=$($("#wwm-svg-logo").html());return e.width(o||"100%"),this.prepend(e),this},$.fn.showCanvasLogo=function(o){function e(o,e,n,i,r){var t=e*(Math.sqrt(3)/2);o.fillStyle=r,o.beginPath(),o.moveTo(n,i-t/2),o.lineTo(n-e/2,i+t/2),o.lineTo(n+e/2,i+t/2),o.lineTo(n,i-t/2),o.shadowOffsetX=1,o.shadowOffsetY=3,o.shadowBlur=1,o.shadowColor="rgb(204, 204, 204)",o.fill()}function n(o,e,n,i,r){var t=e*(Math.sqrt(3)/2);o.fillStyle=r,o.beginPath(),o.moveTo(n,i-t/2),o.lineTo(n-e,i-t/2),o.lineTo(n-e/2,i+t/2),o.lineTo(n,i-t/2),o.shadowOffsetX=1,o.shadowOffsetY=3,o.shadowBlur=1,o.shadowColor="rgb(204, 204, 204)",o.fill()}var i=$($("#wwm-canvas-logo").html()),r=i[0],t=r.getContext("2d");return e(t,50,r.width/2+13,r.height/2,"magenta"),n(t,50,r.width/2+7,r.height/2,"cyan"),e(t,50,r.width/2-16,r.height/2-49,"yellow"),n(t,50,r.width/2+36,r.height/2+49,"greenyellow"),i.width(o||"100%"),this.prepend(i),this};var wwm=function(){function o(){wwm.model.initModule(),wwm.shell.initModule()}return{initModule:o}}();$(function(){var o="a35623411563ec424430d3bd5dc7a93e";$.ajaxSetup({cache:!0}),$.getScript("//connect.facebook.net/ko_KR/sdk.js",function(){FB.init({appId:"1617440885181938",xfbml:!0,version:"v2.4"})}),Kakao.init(o),wwm.initModule()}),wwm.model=function(){var o=function(o){var e=$.Deferred();return $.ajax("/join",{data:o,type:"post",contentType:"application/x-www-form-urlencoded;charset=utf-8"}).done(function(o){e.resolve(o)}).fail(function(o){e.reject(o)}),e.promise()},e=function(o){var e=$.Deferred();return $.get("/rooms/"+o).done(function(o){0===o.length?e.reject("no_room"):e.resolve(o)}).fail(function(o){e.reject(o)}),e.promise()},n=function(o){var e=$.Deferred();return $.get("/member/"+o).done(function(o){e.resolve(o)}).fail(function(o){e.reject(o)}),e.promise()},i=function(o){var e=$.Deferred();return $.get("/search/"+o).done(function(o){0===o.length&&e.reject("no_room"),e.resolve(o)}).fail(function(o){e.reject(o)}),e.promise()},r=function(o,e){var n=$.Deferred();return $.post("/ban/"+o,{rid:e}).done(function(o){console.log(o),n.resolve(o)}).fail(function(o){console.log(o),n.reject(o)}),n.promise()},t=function(){},l=function(o,e){var n=$.Deferred();return $.post("/changeroom/"+o,{title:e}).done(function(o){console.log(o),n.resolve(o)}).fail(function(o){console.log(o),n.reject(o)}),n.promise()},a=function(o,e){var n=$.Deferred();return $.post("/changeroom/"+o,{limit:e}).done(function(o){console.log(o),n.resolve(o)}).fail(function(o){console.log(o),n.reject(o)}),n.promise()},s=function(o){var e=$.Deferred(),n=o.rid;return o.day=JSON.stringify(o.day),o.night=JSON.stringify(o.night),$.post("/confirm/"+n,o).done(function(o){console.log(o),e.resolve(o)}).fail(function(o){console.log("confirmerror",o),e.reject(o)}),e.promise()},c=function(o){var e=$.Deferred(),i=n(o.maker);return i.done(function(n){if(n.roomcount>=3){var i="방은 최대 세 개까지 만들 수 있습니다.";e.reject(i)}else $.post("/addroom/"+o.rid,o).done(function(o){e.resolve(o)}).fail(function(o){console.log(o),e.reject(o)})}),i.fail(function(o){console.log(o),e.reject(o)}),e.promise()},d=function(o,e){var n=$.Deferred();return $.post("/deleteroom/"+o,{maker:e}).done(function(o){if(console.log(o),"no_room"===o){var e="심각한 오류! 방장이 아닙니다.";n.reject(e)}n.resolve(o)}).fail(function(o){n.reject(o)}),n.promise()},m=function(){localStorage.login?window.userInfo=JSON.parse(localStorage.login):window.userInfo={}};return{initModule:m,createRoom:c,getRoomList:e,getUser:n,enterRoom:t,deleteRoom:d,ban:r,changeTitle:l,changeLimit:a,searchList:i,confirm:s,join:o}}(),wwm.shell=function(){var o={$con:$("#whenwemeet"),$view:$("#view"),$modal:$("#modal"),$logo:$("#logo")},e=function(o){var e=o.originalEvent.state,n=e.mod;switch(console.log("onpopstate",n),n){case"login":window.userInfo=e.data,localStorage.login=JSON.stringify(e.data),localStorage.loginType=e.type,wwm.lobby.initModule();break;case"directlogin":wwm.login.initModule();break;case"lobby":wwm.lobby.initModule();break;case"intro":wwm.modal.initModule($("#wwm-intro").html());break;case"search":wwm.lobby.showSearchResult(e.data);break;case"logout":delete window.userInfo,localStorage.removeItem("login"),localStorage.removeItem("loginType"),wwm.login.initModule();break;case"room":wwm.room.initModule(e.data,"enter");break;case"confirm":break;default:wwm.shell.initModule()}},n=function(){console.log("login",localStorage.login),console.log("first",localStorage.first),$(window).on("popstate",e);var o=localStorage.login&&JSON.parse(localStorage.login),n=localStorage.first&&JSON.parse(localStorage.first);n&&(history.pushState({mod:"intro"},"","/intro"),wwm.modal.initModule($("#wwm-intro").html())),o?(history.pushState({mode:"lobby",id:userInfo.id},"","/lobby/"+userInfo.id),wwm.lobby.initModule()):(history.pushState({mode:"directlogin"},"","/login"),wwm.login.initModule())};return{initModule:n,view:o.$view,modal:o.$modal,logo:o.$logo}}(),wwm.confirm=function(){function o(o){c={$con:o,$toLobby:o.find("#to-lobby"),$toRoom:o.find("#to-room"),$toKakao:o.find("#result-to-kakao"),$toFacebook:o.find("#result-to-fb"),$result:o.find("#result")}}function e(){for(var o=[],e=[],n=0;12>n;n++)for(var i=0;7>i;i++)0===m.dayArray[n][i].length&&o.push([n,i]);return[o,e]}function n(o){}function i(){var o="가능한 시간은입니다.";c.$result.html(o)}function r(){c.$con.hide(),wwm.lobby.initModule(c.$con)}function t(){c.$con.hide()}function l(){}function a(){}function s(s){m=s;var f=$("#wwm-confirm").html();d.$con.html(f),o(d.$con);var u=e();n(u),i(),c.$toLobby.click(r),c.$toRoom.click(t),c.$toKakao.click(l),c.$toFacebook.click(a),c.$con.show()}var c,d={$con:$("#modal")},m={};return{initModule:s}}(),wwm.lobby=function(){function o(){wwm.modal.initModule($("#wwm-createroom-modal").html())}function e(){var o=(new Spinner).spin();m.$list.append(o.el);var e=$(document.createDocumentFragment()),n=wwm.model.getRoomList(userInfo.id);n.done(function(o){for(var n=0;n<o.length;n++){var i=o[n],r=$("#wwm-room-list").html(),t=dust.loadSource(dust.compile(r)),l=i.password||!1,a=!1;if(l)for(var s=0;s<i.members.length;s++)if(i.members[s].id==userInfo.id){a=!0;break}var c={rid:i.rid,picture:i.picture,title:i.title,current:i.members.length,limit:i.limit,result:i.result,password:l,unlocked:a};console.log("parser",c,l),dust.render(t,c,function(o,n){console.log(r,t,n),e.append(n)})}m.$list.html(e)}),n.fail(function(o){return"no_room"===o?void m.$list.html('<span class="info-message">방이 없습니다. 방을 만들어보세요.</span>'):(console.log(o),void m.$list.html(o.responseText))}),n.always(function(){$(o.el).remove()})}function n(o){o.preventDefault();var e=$(this).parent().prev().val().trim();console.log("query",e);var n=(new Spinner).spin();m.$list.append(n.el);var r=wwm.model.searchList(e);r.done(function(o){history.pushState({mod:"search",data:o},"","/search/"+e),i(o)}),r.fail(function(o){return"no_room"===o?void m.$list.html('<span class="info-message">검색 결과가 없습니다.</span>'):(console.log(o),void m.$list.html(o.responseText))}),r.always(function(){$(n.el).remove()})}function i(o){for(var e=$(document.createDocumentFragment()),n=0;n<o.length;n++){var i=o[n],r=$("#wwm-room-list").html(),t=dust.loadSource(dust.compile(r)),l=i.password||!1,a=!1;if(l)for(var s=0;s<i.members.length;s++)if(i.members[s].id==userInfo.id){a=!0;break}var c={rid:i.rid,picture:i.picture,title:i.title,current:i.members.length,limit:i.limit,result:i.result,password:l,unlocked:a};console.log("parser",c,l),dust.render(t,c,function(o,n){console.log(r,t,n),e.append(n)})}m.$list.html(e)}function r(){history.pushState({mod:"logout"},"","/"),delete window.userInfo,localStorage.removeItem("login"),localStorage.removeItem("loginType"),wwm.login.initModule()}function t(){var o,e=$(this),n=$(this).data("rid"),i=(new Spinner).spin();if(m.$list.append(i.el),$(this).has(".locked").length&&(o=prompt("비밀번호",""),null===o||""===o.trim()))return void $(i.el).remove();var r=$.post("/enterroom/"+n,{pw:o,pid:userInfo.id,name:userInfo.name,picture:userInfo.picture});r.done(function(o){return"no_room"===o?void alert("방이 없습니다"):"wrong_password"===o?void alert("비밀번호가 틀렸습니다."):"ban"===o?void alert("강퇴당한 방에는 들어갈 수 없습니다."):(o.current=e.find(".current").text(),console.log("enter room post result",o),history.pushState({mod:"room",data:o},"","/room/"+n),void wwm.room.initModule(o,"enter"))}).fail(function(o){console.log(o.responseText),alert("오류발생! 콘솔확인")}).always(function(){$(i.el).remove()})}function l(){console.log("refreshlist"),e()}function a(){var o=wwm.model.getUser(userInfo.id);o.done(function(o){m.$profilePicture.attr("src",o.picture),m.$profileName.text(o.name),userInfo.picture=o.picture,userInfo.name=o.name;var e=JSON.parse(localStorage.login);e.picture=o.picture,e.name=o.name,localStorage.login=JSON.stringify(e)})}function s(){history.pushState({mod:"confirm"},"","/result"),wwm.confirm.initModule()}function c(o){m={$con:o,$showCreateroom:o.find("#show-createroom-modal"),$searchroomBtn:o.find("#searchroom-btn"),$list:o.find("#rooms"),$logout:o.find("#logout-btn"),$refresh:o.find("#refresh-list"),$refreshProfile:o.find("#refresh-profile"),$result:o.find(".result"),$profilePicture:o.find("#profile-picture"),$profileName:o.find("#profile-name")}}function d(){localStorage.login||(history.pushState({mod:"login"},"","/login"),wwm.login.initModule()),window.userInfo||(window.userInfo=JSON.parse(localStorage.login));var i=$("#wwm-lobby").text(),d=userInfo.name,u=userInfo.picture;dust.render(dust.loadSource(dust.compile(i)),{name:d,picture:u},function(i,d){i?(console.log(i),alert("rendering error! 콘솔 확인")):(wwm.shell.view.html(d).fadeIn("slow"),c(wwm.shell.view),null===u&&m.$profilePicture.replaceWith($('<div style="display:inline;"/>').showCanvasLogo(60)),e(),m.$showCreateroom.click(o),m.$searchroomBtn.click(n),m.$logout.click(r),m.$refresh.click(l),m.$refreshProfile.click(a),f.on("titleChanged",function(o){for(var e=$(".room"),n=e.map(function(o,e){$(e).data("rid")}).get(),i=0;i<n.length;i++)if(o.rid===n[i]){e.eq(i).find(".title").text(o.title);break}}),f.on("currentChanged",function(o){for(var e=$(".room"),n=e.map(function(o,e){$(e).data("rid")}).get(),i=0;i<n.length;i++)if(o.rid===n[i]){e.eq(i).find(".current").text(o.number);break}}),f.on("limitChanged",function(o){for(var e=$(".room"),n=e.map(function(o,e){$(e).data("rid")}).get(),i=0;i<n.length;i++)if(o.rid===n[i]){e.eq(i).find(".total").text(o.number);break}}),$(document).on("click",".room",t),$(document).on("click",".result",s))})}var m,f=io();return{initModule:d,showSearchResult:i}}(),wwm.login=function(){var o,e=function(){var o={id:"123456789",name:"관리자",picture:null},e=wwm.model.join(o);e.fail(function(o){alert("가입 오류 발생!"),console.log(o.responseText)}),history.pushState({mod:"login",data:o,type:"local"},"","/lobby/123456789"),window.userInfo=o,localStorage.login=JSON.stringify(o),localStorage.loginType="local",wwm.lobby.initModule(wwm.shell.view)},n=function(){var o={id:"987654321",name:"테스터",picture:null},e=wwm.model.join(o);e.fail(function(o){alert("가입 오류 발생!"),console.log(o.responseText)}),history.pushState({mod:"login",data:o,type:"local2"},"","/lobby/987654321"),window.userInfo=o,localStorage.login=JSON.stringify(o),localStorage.loginType="local2",wwm.lobby.initModule(wwm.shell.view)},i=function(){Kakao.Auth.login({success:function(){Kakao.API.request({url:"/v1/user/me",success:function(o){console.log(JSON.stringify(o)),o.name=o.properties.nickname,o.picture=o.properties.profile_image;var e=wwm.model.join(o);e.fail(function(o){alert("가입 오류 발생!"),console.log(o.responseText)}),history.pushState({mod:"login",data:o,type:"kakao"},"","/lobby/"+o.id),window.userInfo=o,localStorage.login=JSON.stringify(o),localStorage.loginType="kakao",wwm.lobby.initModule(wwm.shell.view)},fail:function(o){alert(JSON.stringify(o))}})},fail:function(o){alert(JSON.stringify(o))}})},r=function(){FB.login(function(o){"connected"===o.status?FB.api("/me",function(o){console.log(JSON.stringify(o)),o.picture="//graph.facebook.com/"+o.id+"/picture";var e=wwm.model.join(o);e.fail(function(o){alert("가입 오류 발생!"),console.log(o.responseText)}),history.pushState({mod:"login",data:o,type:"facebook"},"","/lobby/"+o.id),window.userInfo=o,localStorage.login=JSON.stringify(o),localStorage.loginType="facebook",wwm.lobby.initModule(wwm.shell.view)}):"not_authorized"===o.status?alert("Please log log into this app."):alert("Please log into Facebook.")})},t=function(e){o={$con:e,$logo:e.find("#login-logo"),$wrapper:e.find("#login-wrapper"),$kakaoLogin:e.find("#kakao-login-btn"),$fbLogin:e.find("#fb-login-btn"),$localhost:e.find("#localhost-login"),$localhost2:e.find("#localhost2-login")}},l=function(){wwm.shell.view.html($("#wwm-login").html()),t(wwm.shell.view),o.$logo.showSVGLogo(100),o.$logo.animate({height:"70%"}),o.$wrapper.fadeIn("slow"),o.$kakaoLogin.on({click:i,mouseover:function(){this.src="/kakao_account_login_btn_medium_narrow_ov.png"},mouseout:function(){this.src="/kakao_account_login_btn_medium_narrow.png"}}),o.$fbLogin.on({click:r,mouseover:function(){this.src="/facebook_ov.png"},mouseout:function(){this.src="/facebook.png"}}),o.$localhost.click(e),o.$localhost2.click(n)};return{initModule:l}}(),wwm.modal=function(){function o(o){r={$con:o,$close:o.find(".modal-close"),$title:o.find("#room-title"),$limit:o.find("#room-people-limit"),$password:o.find("#room-password"),$createRoom:o.find("#create-room-btn")}}function e(o){o.preventDefault(),wwm.shell.modal.hide()}function n(o){o.preventDefault();var e=(new Spinner).spin();r.$con.append(e.el);var n=r.$title.val().trim(),i=r.$limit.val(),t=r.$password.val().trim()||null,l=userInfo.id.toString(),a=userInfo.picture;if(!n)return $(e.el).remove(),void alert("제목을 입력하세요.");var s={rid:(new Date).getTime().toString(),title:n,maker:l,limit:i,picture:a,password:t,members:JSON.stringify([{id:userInfo.id,name:userInfo.name,picture:userInfo.picture,confirm:!1}])};console.log("createroom data",s);var c=wwm.model.createRoom(s);c.done(function(o){console.log(o),s.current=1,wwm.room.initModule(s,"create"),wwm.shell.modal.hide()}),c.fail(function(o){console.log(o),alert("방 생성에러! 콘솔확인")}),c.always(function(){$(e.el).remove()})}function i(i){wwm.shell.modal.html(i),o(wwm.shell.modal),wwm.shell.modal.fadeIn("slow"),r.$close.click(e),r.$createRoom.click(n)}var r;return{initModule:i}}(),wwm.room=function(){function o(o){j={$con:o,$calendar:o.find("table"),$dayTable:o.find("#day-table"),$nightTable:o.find("#night-table"),$thDay:o.find("table").find("tr").eq(0).find("th"),$thTime:o.find("table").find("tr").find("th:first-child"),$memberList:o.find("#member-list"),$day:o.find("#day"),$night:o.find("#night"),$back:o.find("#room-back"),$quit:o.find("#quit"),$myMenu:o.find("#my-menu"),$admin:o.find("#manage-btn, #invite-btn"),$dayExp:o.find("#day-exc-btn"),$notDay:o.find("#day-exception").find("li"),$timeExp:o.find("#time-exc-btn"),$notTime:o.find("#time-exception").find("li"),$explode:o.find("#explode-room"),$ban:o.find("#ban-people-btn"),$banList:o.find("#ban-member-list"),$changeLimit:o.find("#change-limit-btn"),$changeTitle:o.find("#change-room-title"),$title:o.find("#title"),$current:o.find("#current-number"),$limit:o.find("#limit-number"),$sendChat:o.find("#send-chat"),$chatList:o.find("#chat-list"),$confirm:o.find("#confirm-calendar"),$refresh:o.find("#refresh-calendar"),$allConfirmed:o.find("#all-confirmed"),$kakaoInvite:o.find("#kakao-invite"),$fbInvite:o.find("#fb-invite")}}function e(o){var n=new Array(o||0),i=o,r=0;if(arguments.length>1)for(var t=Array.prototype.slice.call(arguments,1);i--;)n[o-1-i]=e.apply(this,t);if(1==arguments.length)for(r;r<n.length;r++)n[r]=[];return n}function n(o){console.log("tableToArray");for(var e=[],n=0;n<o.length;n++){var i=o[n],r=[i.parentNode.rowIndex-1,i.cellIndex-1];e.push(r)}return console.log("tableToArray",e),e}function i(o,e,n,i){console.log("arrayTotable",o,e,n,i);var r,t,l,a,s,c,d;if("day"===n){for(r=0;r<o.length;r++){l=o[r],s=j.$dayTable.find("tr").eq(l[0]+1).find("td").eq(l[1]);var m=J.dayArray[l[0]][l[1]];if(i){for(m.push(e),a=m.length,s.find("div").remove(),c=$("<div/>").addClass("box-"+a),t=0;a>t;t++)c.append($("<div/>",{"class":F.colorList[m[t]]}));c.appendTo(s)}else{for(d=m.indexOf(e),d>-1&&m.splice(d,1),a=m.length,s.find("div").remove(),c=$("<div/>").addClass("box-"+a),t=0;a>t;t++)console.log(F.colorList[m[t]]),c.append($("<div/>",{"class":F.colorList[m[t]]}));c.appendTo(s)}J.dayArray[l[0]][l[1]]=m}console.log("arrToTable:day",J.dayArray,J.nightArray)}else if("night"===n){for(r=0;r<o.length;r++){l=o[r],s=j.$nightTable.find("tr").eq(l[0]+1).find("td").eq(l[1]);var f=J.nightArray[l[0]][l[1]];if(i){for(f.push(e),a=f.length,s.find("div").remove(),c=$("<div/>").addClass("box-"+a),t=0;a>t;t++)c.append($("<div/>",{"class":F.colorList[f[t]]}));c.appendTo(s)}else{for(d=f.indexOf(e),d>-1&&f.splice(d,1),a=f.length,s.find("div").remove(),c=$("<div/>").addClass("box-"+a),t=0;a>t;t++)c.append($("<div/>",{"class":F.colorList[f[t]]}));c.appendTo(s)}J.nightArray[l[0]][l[1]]=f}console.log("arrToTable:night",J.dayArray,J.nightArray)}}function r(){var o,e,n,i,r,t;for(o=0;12>o;o++)for(e=0;7>e;e++){i=j.$dayTable.find("tr").eq(o+1).find("td").eq(e);var l=J.dayArray[o][e];if(r=l.length,i.find("div").remove(),r>0){for(t=$("<div/>").addClass("box-"+r),n=0;r>n;n++)t.append($("<div/>",{"class":F.colorList[l[n]]}));t.appendTo(i)}}for(o=0;12>o;o++)for(e=0;7>e;e++){i=j.$nightTable.find("tr").eq(o+1).find("td").eq(e);var a=J.nightArray[o][e];if(r=a.length,i.find("div").remove(),r>0){for(t=$("<div/>").addClass("box-"+r),n=0;r>n;n++)t.append($("<div/>",{"class":F.colorList[a[n]]}));t.appendTo(i)}}}function t(){console.log("showMembers",J.memberList),j.$memberList.find("ul").empty();for(var o=$("#wwm-member-list").html(),e=0;e<J.memberList.length;e++){var n=J.memberList[e];dust.render(dust.loadSource(dust.compile(o)),{id:n.id,color:F.colorList[e],name:n.name},function(o,e){o?j.$memberList.find("ul").html(o):j.$memberList.find("ul").append(e)})}a()}function l(o){console.log("newMember",o,o.id,J.memberList);var e=$("#wwm-member-list").html();J.memberList.push({id:o.id,name:o.name,picture:o.picture,confirm:!1}),j.$banList.append('<option value="'+o.id+'">'+s(o.id).name+"</option>"),dust.render(dust.loadSource(dust.compile(e)),{id:o.id,color:s(id).color,name:o.name},function(o,e){o?j.$memberList.find("ul").html(o):j.$memberList.find("ul").append(e)}),a()}function a(){console.log("showOnline onlineList",J.onlineList);for(var o=0;o<J.memberList.length;o++){var e=j.$memberList.find("li").eq(o);J.onlineList[o]?0!==e.has(".offline").length&&e.find(".offline").toggleClass("offline online"):0!==e.has(".online").length&&e.find(".online").toggleClass("online offline")}}function s(o){console.log("findInfo",o);for(var e={},n=0;n<J.memberList.length;n++)o==J.memberList[n].id&&(e.personColor=n,e.name=J.memberList[n].name,e.color=F.colorList[n]);return e}function c(o){o.preventDefault();var e=$(this).prev().val();if(console.log("ban",e),e==J.maker)return void alert("자기 자신을 강퇴시키면 안 되겠죠?");var n=wwm.model.ban(e,o.data.rid);n.done(function(){R.emit("ban",{id:e,order:s(e).personColor})}),n.fail(function(o){console.log(o),alert("퇴장당하지 않으려고 버티는중! 다시 시도하세요.")})}function d(o){o.preventDefault();var e=$(this).prev().val();console.log("changeTitle",e);var n=wwm.model.changeTitle(J.rid,e);n.done(function(){J.title=e,j.$title.text(e)}),n.fail(function(o){alert("제목 바꾸기 실패!"),console.log(o)})}function m(o){o.preventDefault();var e=$(this).prev().val();if(console.log("changeLiimit",e),e<J.current)return void alert("현재 사람이 설정한 수보다 많습니다.");var n=wwm.model.changeLimit(J,e);n.done(function(){S(e)}),n.fail(function(o){alert("인원수 바꾸기 실패!"),console.log(o)})}function f(){y(),console.log("onClickDay");var o,e=this.cellIndex-1;o="day"===J.now?J.dayArray:J.nightArray;for(var n=[],i=!0,r=0;12>r;r++)-1==o[r][e].indexOf(J.myInfo.personColor)&&(i=!1),n.push([r,e]);i?($(this).removeClass("selected"),R.emit("not-busy",{cur:J.now,sid:J.myInfo.personColor,arr:n})):($(this).addClass("selected"),R.emit("busy",{cur:J.now,sid:J.myInfo.personColor,arr:n}))}function u(){y();var o=this.parentNode.rowIndex-1;console.log("onClickTime",o);var e;e="day"===J.now?J.dayArray:J.nightArray;var n=[],i=!0;console.log(e[o]);for(var r=0;7>r;r++)-1==e[o][r].indexOf(J.myInfo.personColor)&&(i=!1),n.push([o,r]);i?($(this).removeClass("selected"),R.emit("not-busy",{cur:J.now,sid:J.myInfo.personColor,arr:n})):($(this).addClass("selected"),R.emit("busy",{cur:J.now,sid:J.myInfo.personColor,arr:n}))}function g(o){o.stopPropagation(),console.log("showAdminMenu");var e=$(this);j.$myMenu.find("ul").hide(),e.hasClass("opened")?(e.removeClass("opened"),e.prev("ul").hide()):(e.addClass("opened"),e.prev("ul").show())}function h(o){o.stopPropagation(),console.log("showDayException");var e=$(this);j.$myMenu.find("ul").hide(),e.hasClass("opened")?(e.removeClass("opened"),e.prev("ul").hide()):(e.addClass("opened"),e.prev("ul").show())}function p(o){o.stopPropagation(),console.log("showTimeexception");var e=$(this);j.$myMenu.find("ul").hide(),e.hasClass("opened")?(e.removeClass("opened"),e.prev("ul").hide()):(e.addClass("opened"),e.prev("ul").show())}function w(o){console.log("deleteRoom",o.data.rid);var e=o.data.rid,n=wwm.model.deleteRoom(e,userInfo.id);n.done(function(){alert("삭제되었습니다."),wwm.lobby.initModule(j.$con),R.emit("explode",e)}),n.fail(function(o){console.log(o),alert("방 지우기 오류발생")})}function y(){j.$confirm.hasClass("confirmed")&&(alert("확정 상태가 해제됩니다."),j.$confirm.removeClass("confirmed"),J.myInfo.confirm=!1,R.emit("confirmed",{id:J.myInfo.id,bool:!1}))}function b(){console.log("onclickCell"),y();var o,e;o="day"===J.now?J.dayArray:J.nightArray,e=o[this.parentNode.rowIndex-1][this.cellIndex-1],console.log("not-busy",e,e.length,J.myInfo.personColor),e?(console.log(e.indexOf(J.myInfo.personColor)>-1),e.length&&e.indexOf(J.myInfo.personColor)>-1?R.emit("not-busy",{cur:J.now,sid:J.myInfo.personColor,arr:n([this],!1)}):R.emit("busy",{cur:J.now,sid:J.myInfo.personColor,arr:n([this],!0)})):R.emit("busy",{cur:J.now,sid:J.myInfo.personColor,arr:n([this],!0)})}function v(){y();var o=$(this).index();console.log("excludeDay",o);for(var e=[],n=0;12>n;n++)e.push([n,o]);$(this).hasClass("selected")?(R.emit("not-busy",{cur:"day",sid:J.myInfo.personColor,arr:e}),R.emit("not-busy",{cur:"night",sid:J.myInfo.personColor,arr:e}),$(this).removeClass("selected")):(R.emit("busy",{cur:"day",sid:J.myInfo.personColor,arr:e}),R.emit("busy",{cur:"night",sid:J.myInfo.personColor,arr:e}),$(this).addClass("selected"))}function k(){y();var o,e,n=$(this).index(),i=$(this).find("input").val();if(console.log("excludeTime",n,i),i){var r=[];if(0===n){for(o=0;i>o;o++)for(e=0;7>e;e++)r.push([i,e]);console.log("arr",r),$(this).hasClass("selected")?(R.emit("not-busy",{cur:"day",sid:J.myInfo.personColor,arr:r}),R.emit("not-busy",{cur:"night",sid:J.myInfo.personColor,arr:r}),$(this).removeClass("selected")):(R.emit("busy",{cur:"day",sid:J.myInfo.personColor,arr:r}),R.emit("busy",{cur:"night",sid:J.myInfo.personColor,arr:r}),$(this).addClass("selected"))}else{for(o=i-1;12>o;o++)for(e=0;7>e;e++)console.log(r),r.push([i,e]);console.log("arr",r),$(this).hasClass("selected")?(R.emit("not-busy",{cur:"day",sid:J.myInfo.personColor,arr:r}),R.emit("not-busy",{cur:"night",sid:J.myInfo.personColor,arr:r}),$(this).removeClass("selected")):(R.emit("busy",{cur:"day",sid:J.myInfo.personColor,arr:r}),R.emit("busy",{cur:"night",sid:J.myInfo.personColor,arr:r}),$(this).addClass("selected"))}}}function I(o){console.log("toLobby",o.data.rid),confirm("확정 버튼을 누르지 않고 나가면 저장되지 않은 사항은 사라집니다.")&&(history.pushState({mod:"lobby"},"","/lobby/"+J.myInfo.id),R.emit("out",{id:J.myInfo.id,rid:o.data.rid}),wwm.lobby.initModule(j.$con))}function L(o){return console.log("quit",o.data.rid),1===J.current?void(confirm("혼자 있을 때 방을 나가면 방이 사라집니다.그래도 나가시겠습니까?")&&wwm.model.deleteRoom(o.data.rid,J.myInfo.id)):void(confirm("정말 나가시겠습니까? 잠시 나가는 거면 목록 버튼을 클릭하세요.")&&(history.replaceState({mod:"lobby"},"","/lobby/"+J.myInfo.id),R.emit("quit",{id:J.myInfo.id,rid:o.data.rid}),wwm.lobby.initModule(j.$con)))}function C(o){console.log("changeCurrentNumber",o),J.current+=o,j.$current.text(J.current),$("#current-people-number").val(J.current)}function S(o){console.log("changeLimitNumber",o),J.limit=o,j.$limit.text(o)}function x(o){o.preventDefault();var e=$(this).parent().prev().val();console.log("sendChat",J.myInfo.id,e),R.emit("chat",{id:J.myInfo.id,name:J.myInfo.name,text:e})}function T(){console.log("refresh",{rid:J.rid,id:J.myInfo.id}),R.on("responseArr",function(o){console.log("socket responseArr"),J.dayArray=o.day,J.nightArray=o.night}),R.emit("requestArr",{rid:J.rid,id:J.myInfo.id})}function A(o){console.log("confirm",o.data);var e=o.data;if(e.bool=!J.myInfo.confirm,console.log(e),j.$confirm.hasClass("confirmed"))j.$confirm.removeClass("confirmed"),J.myInfo.confirm=!1;else{var n=wwm.model.confirm(e);n.done(function(){J.myInfo.confirm=!0,j.$confirm.addClass("confirmed")}),n.fail(function(o){console.log(o),alert("confirm error!")})}R.emit("confirmed",{id:J.myInfo.id,bool:e.bool})}function M(){console.log("toDay",J.now),J.now="day",j.$night.css("background","white"),j.$day.css("background","crimson"),j.$dayTable.show(),j.$nightTable.hide()}function O(){console.log("toNight",J.now),J.now="night",j.$day.css("background","white"),j.$night.css("background","crimson"),j.$dayTable.hide(),j.$nightTable.show()}function q(){console.log("toConfirmPage",J),wwm.confirm.initModule(J)}function _(){Kakao.Link.createTalkLinkButton({container:"#kakao-invite",label:"카카오링크 샘플에 오신 것을 환영합니다.",image:{src:"http://dn.api1.kage.kakao.co.kr/14/dn/btqaWmFftyx/tBbQPH764Maw2R6IBhXd6K/o.jpg",width:"300",height:"200"},webButton:{text:"우리 언제 만나",url:"http://whenwemeet.herokuapp.com"},fail:function(){alert("KakaoLink is currently only supported in iOS and Android platforms.")}})}function D(){FB.ui({method:"send",link:"http%3A%2F%2Fwww.nytimes.com%2F2011%2F06%2F15%2Farts%2Fpeople-argue-just-to-win-scholars-assert.html"})}function N(n,y){console.log("room initModule",y),J.title=n.title,J.limit=Number(n.limit),J.rid=n.rid.toString(),J.maker=n.maker.toString(),console.log("entered room id"+J.rid),console.log("is doc.member array? "+Array.isArray(n.members)),"create"===y?(J.dayArray=e(12,7),J.nightArray=e(12,7)):"enter"===y&&(J.dayArray=n.day||e(12,7),J.nightArray=n.night||e(12,7)),J.memberList=Array.isArray(n.members)?n.members:JSON.parse(n.members),J.current=J.memberList.length,J.myInfo.id=userInfo.id.toString(),J.myInfo.name=userInfo.name;for(var S=0;S<J.memberList.length;S++)if(J.memberList[S].id==userInfo.id){J.myInfo.personColor=S,J.myInfo.confirm=J.memberList[S].confirm;break}J.onlineList[J.myInfo.personColor]=!0,console.log("onlineList",J.onlineList),R.emit("enter",{id:J.myInfo.id,rid:J.rid,name:J.myInfo.name,color:J.myInfo.personColor,picture:userInfo.picture});var N={name:J.myInfo.name,title:J.title,current:J.current,limit:J.limit,members:J.memberList};J.myInfo.id==J.maker&&(N.admin=!0),console.log("admin?",J.myInfo.id==J.maker);var F=$("#wwm-room").text();dust.render(dust.loadSource(dust.compile(F)),N,function(e,n){return e?void wwm.shell.view.html(e):(wwm.shell.view.html(n),o(wwm.shell.view),J.myInfo.confirm&&j.$confirm.addClass("confirmed"),t(),R.on("out",function(o){console.log(j.$memberList,j.$memberList.find("[data-id="+o+"]"));for(var e=0;e<J.memberList.length;e++)if(J.memberList[e].id==o){J.onlineList[e]=!1;break}a(),console.log("socketout",J.onlineList,J.memberList)}),R.on("quit",function(o){for(var e=0;e<J.memberList.length;e++)if(J.memberList[e].id==o){J.onlineList.splice(e,1),J.memberList.splice(e,1);break}console.log(j.$memberList,j.$memberList.find("[data-id="+o+"]")),j.$banList.find("[value="+o+"]").remove(),C(-1),t(),console.log("socketquit",J.onlineList,J.memberList)}),R.on("newMember",function(o){console.log("socket newmember",o),J.onlineList[o.color]=!0,R.emit("uptodateArr",{sid:o.socket,day:J.dayArray,night:J.nightArray,online:J.onlineList}),o.color>=J.current&&(C(1),l(o)),a()}),R.on("uptodateArr",function(o){console.log("socket uptodateArr"),J.dayArray=o.day,J.nightArray=o.night,J.onlineList=o.online,a(),r()}),R.on("chat",function(o){console.log("socket chat",o.id,o.text),j.$memberList.find("li").eq(s(o.id).personColor).find(".chat").text(o.text)}),R.on("busy",function(o){console.log("socketbusy:",o.arr,o.sid,o.cur),i(o.arr,o.sid,o.cur,!0)}),R.on("not-busy",function(o){console.log("socketnotbusy:",o.arr,o.sid,o.cur),i(o.arr,o.sid,o.cur,!1)}),R.on("requestArr",function(o){console.log("socket requestArr"),R.emit("responseArr",{sid:o.sid,day:J.dayArray,night:J.nightArray})}),R.on("ban",function(o){if(J.myInfo.personColor==o.id)return alert("강퇴당하셨습니다..."),void wwm.lobby.initModule(j.$con);J.myInfo.personColor>o.order&&J.myInfo.personColor--,alert(s(id).name+"님이 강제퇴장 되었습니다. 잘가요!");for(var e=0;e<J.memberList.length;e++)if(banned==J.memberList[e].id){J.memberList.splice(e,1),J.onlineList.splice(e,1);break}C(-1),j.$banList.find("option").eq(o.order).remove(),t(),console.log("socket ban")}),R.on("confirmed",function(o){for(var e=0,n=0;n<J.memberList.length;n++)J.memberList[n].id==o.id&&(J.memberList[n].confirm=o.bool),J.memberList[n].confirm===!0&&e++;e==J.memberList.length?j.$allConfirmed.show():j.$allConfirmed.hide(),console.log("socket confirmed")}),R.on("explode",function(){alert("방이 폭파되었습니다. 로비로 이동합니다."),wwm.lobby.initModule(j.$con),console.log("socket explode")}),j.$calendar.find("td").click(b),j.$explode.click({id:J.rid},w),j.$back.click({rid:J.rid},I),j.$day.click(M),j.$night.click(O),j.$admin.click(g),j.$dayExp.click(h),j.$timeExp.click(p),j.$ban.click({rid:J.rid},c),j.$changeLimit.click({id:J.rid},m),j.$changeTitle.click({id:J.rid},d),j.$sendChat.click(x),j.$notDay.click(v),j.$notTime.click(k),j.$thDay.click(f),j.$thTime.click(u),j.$confirm.click({id:J.myInfo.id,rid:J.rid,day:J.dayArray,night:J.nightArray},A),j.$refresh.click(T),j.$allConfirmed.click(q),j.$quit.click({id:J.myInfo.id,rid:J.rid},L),j.$kakaoInvite.on({click:_,mouseover:function(){this.src="/kakaolink_btn_medium_ov.png"},mouseout:function(){this.src="/kakaolink_btn_medium.png"}}),void j.$fbInvite.on({click:D,mouseover:function(){this.src="/facebook_invite_ov.png"},mouseout:function(){this.src="/facebook_invite.png"}}))})}var j,J={now:"day",dayArray:null,nightArray:null,memberList:[],myInfo:{id:null,name:null,confirm:!1,personColor:0},onlineList:new Array(8),maker:0,rid:null,title:null,limit:0,current:0},F={$con:$("#view"),colorList:["red","orange","yellow","yellowgreen","skyblue","purple","violet","pink"]},R=io();return{initModule:N,info:J}}();