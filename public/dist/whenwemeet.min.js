window.onerror=function(o,e,n,i,t){"string"==typeof o&&o.indexOf("Script error.")>-1||console.log("Error: ",o," Script: "+e+" Line: "+n+" Column: "+i+" StackTrace: "+t)},$.fn.showSVGLogo=function(o){var e=$($("#wwm-svg-logo").html());return e.width(o||"100%"),this.prepend(e),this},$.fn.showCanvasLogo=function(o){var e=$($("#wwm-canvas-logo").html()),n=e[0],i=n.getContext("2d"),t=function(o,e,n,i,t){var r=e*(Math.sqrt(3)/2);o.fillStyle=t,o.beginPath(),o.moveTo(n,i-r/2),o.lineTo(n-e/2,i+r/2),o.lineTo(n+e/2,i+r/2),o.lineTo(n,i-r/2),o.shadowOffsetX=1,o.shadowOffsetY=3,o.shadowBlur=1,o.shadowColor="rgb(204, 204, 204)",o.fill()},r=function(o,e,n,i,t){var r=e*(Math.sqrt(3)/2);o.fillStyle=t,o.beginPath(),o.moveTo(n,i-r/2),o.lineTo(n-e,i-r/2),o.lineTo(n-e/2,i+r/2),o.lineTo(n,i-r/2),o.shadowOffsetX=1,o.shadowOffsetY=3,o.shadowBlur=1,o.shadowColor="rgb(204, 204, 204)",o.fill()};return t(i,50,n.width/2+13,n.height/2,"magenta"),r(i,50,n.width/2+7,n.height/2,"cyan"),t(i,50,n.width/2-16,n.height/2-49,"yellow"),r(i,50,n.width/2+36,n.height/2+49,"greenyellow"),e.width(o||"100%"),this.prepend(e),this};var eval_dust_string=function(o,e,n){var i;return"function"==typeof o&&(0===o.length?o=o():(i="",e.tap(function(o){return i+=o,""}).render(o,n).untap(),o=i)),o};dust.helpers||(dust.helpers={}),dust.helpers.repeat=function(o,e,n,i){var t,r;if(r=parseInt(eval_dust_string(i.times,o,e)),null!==r&&!isNaN(r)){for(null!==e.stack.head&&(e.stack.head.$len=r),t=0;r>t;t++)null!==e.stack.head&&(e.stack.head.$idx=t),o=n.block(o,e.push(t,t,r));null!==e.stack.head&&(e.stack.head.$idx=0),null!==e.stack.head&&(e.stack.head.$len=0)}return o};var wwm=function(){"use strict";var o;return o=function(){wwm.model.initModule(),wwm.shell.initModule()},{initModule:o}}();wwm.model=function(){"use strict";var o,e,n,i,t,r,l,a,s,c,d,m,f,u;return o=function(o){var e=$.Deferred();return $.ajax("/join",{data:o,type:"post",contentType:"application/x-www-form-urlencoded;charset=utf-8"}).done(function(o){e.resolve(o)}).fail(function(o){e.reject(o)}),e.promise()},e=function(o){var e=$.Deferred();return $.get("/rooms/"+o).done(function(o){0===o.length?e.reject("no_room"):e.resolve(o)}).fail(function(o){e.reject(o)}),e.promise()},i=function(o){var e=$.Deferred();return $.get("/member/"+o).done(function(o){e.resolve(o)}).fail(function(o){e.reject(o)}),e.promise()},t=function(o){var e=$.Deferred();return $.post("/search/"+o).done(function(o){0===o.length&&e.reject("no_room"),e.resolve(o)}).fail(function(o){e.reject(o)}),e.promise()},r=function(o){var e,n=$.Deferred(),t=i(o.maker);return t.done(function(i){i.roomcount>=3?(e="방은 최대 세 개까지 만들 수 있습니다.",n.reject(e)):$.post("/addroom/"+o.rid,o).done(function(o){n.resolve(o)}).fail(function(o){console.log(o),n.reject(o)})}),t.fail(function(o){console.log(o),n.reject(o)}),n.promise()},l=function(o){var e=$.Deferred();return $.post("/enterroom/"+o.rid,o).done(function(o){console.log(o),e.resolve(o)}).fail(function(o){console.log(o),e.reject(o)}),e.promise()},a=function(o,e){var n=$.Deferred();return $.post("/ban/"+o,{rid:e}).done(function(o){console.log(o),n.resolve(o)}).fail(function(o){console.log(o),n.reject(o)}),n.promise()},s=function(o,e){var n=$.Deferred();return $.post("/changeroom/"+o,{title:e}).done(function(o){console.log(o),n.resolve(o)}).fail(function(o){console.log(o),n.reject(o)}),n.promise()},c=function(o,e){var n=$.Deferred();return $.post("/changeroom/"+o,{limit:e}).done(function(o){console.log(o),n.resolve(o)}).fail(function(o){console.log(o),n.reject(o)}),n.promise()},d=function(o){var e=$.Deferred(),n=o.rid;return o.day=JSON.stringify(o.day),o.night=JSON.stringify(o.night),console.log("confirm model",o),$.post("/confirm/"+n,o).done(function(o){console.log(o),e.resolve(o)}).fail(function(o){console.log("confirmerror",o),e.reject(o)}),e.promise()},m=function(o,e){var n,i=$.Deferred();return $.post("/deleteroom/"+o,{maker:e}).done(function(o){console.log(o),"no_room"===o&&(n="심각한 오류! 방장이 아닙니다.",i.reject(n)),i.resolve(o)}).fail(function(o){i.reject(o)}),i.promise()},n=function(o){var e,n=$.Deferred();return $.post("/roominfo/"+o).done(function(o){console.log(o),"no_room"===o&&(e="심각한 오류! 방장이 아닙니다.",n.reject(e)),n.resolve(o)}).fail(function(o){n.reject(o)}),n.promise()},f=function(o){var e=$.Deferred();return $.post("/introdone/"+o).done(function(o){console.log(o),e.resolve(o)}).fail(function(o){e.reject(o)}),e.promise()},u=function(){localStorage.login?window.userInfo=JSON.parse(localStorage.login):window.userInfo={}},{initModule:u,createRoom:r,getRoomList:e,getUser:i,enterRoom:l,deleteRoom:m,ban:a,changeTitle:s,changeLimit:c,searchList:t,confirm:d,join:o,getRoomInfo:n,introDone:f}}(),wwm.shell=function(){"use strict";var o,e,n={$con:$("#whenwemeet"),$view:$("#view"),$modal:$("#modal"),$logo:$("#logo"),$intro:$("#intro")};return o=function(o){var e=o.originalEvent.state,n=e.mod;switch(console.log("onpopstate",n),n){case"login":window.userInfo=e.data,localStorage.login=JSON.stringify(e.data),localStorage.loginType=e.type,wwm.lobby.initModule();break;case"directlogin":wwm.login.initModule();break;case"lobby":wwm.lobby.initModule();break;case"intro":wwm.modal.initModule($("#wwm-intro").html());break;case"search":wwm.lobby.searchRoom(e.query);break;case"logout":delete window.userInfo,localStorage.removeItem("login"),localStorage.removeItem("loginType"),wwm.login.initModule();break;case"room":wwm.room.initModule(e.data,"enter");break;case"confirm":break;default:wwm.shell.initModule()}},e=function(){var e=localStorage.login&&JSON.parse(localStorage.login);console.log("login",localStorage.login),console.log("first",localStorage.first),$(window).on("popstate",o),e?(history.pushState({mode:"lobby",id:userInfo.id},"","/lobby/"+userInfo.id),wwm.lobby.initModule()):(history.pushState({mode:"directlogin"},"","/login"),wwm.login.initModule())},{initModule:e,view:n.$view,modal:n.$modal,logo:n.$logo,intro:n.$intro}}(),wwm.confirm=function(){"use strict";var o,e,n,i,t,r,l,a,s,c={};return e=function(e){o={$con:e,$toLobbyBtn:e.find("#to-lobby"),$toRoom:e.find("#to-room"),$toKakao:e.find("#result-to-kakao"),$toFacebook:e.find("#result-to-fb"),$result:e.find("#result")}},n=function(){var o,e,n=[[null,null]],i=[[null,null]],t=[[null,null]],r=[[null,null]],l=[[null,null]],a=[[null,null]],s=[[null,null]],d=[n,i,t,r,l,a,s];return console.log(c.dayArray,c.nightArray),d.forEach(function(n,i){for(e=0,o=0;12>o;o++)console.log(o,0===c.dayArray[o][i].length),0===c.dayArray[o][i].length&&(console.log(null===n[e][0]),null===n[e][0]?(n[e][0]=o,n[e][1]=n[e][0]+1):(console.log(n[e][1]===o),n[e][1]===o?n[e][1]=o+1:n[++e]=[o,o+1])),console.log(n,e);for(o=12;24>o;o++)0===c.nightArray[o-12][i].length&&(null===n[e][0]?(n[e][0]=o,n[e][1]=n[e][0]+1):n[e][1]===o?n[e][1]=o+1:n[++e]=[o,o+1]),console.log(n,e)}),d},i=function(e){var n="",i=["일","월","화","수","목","금","토"],t="";i.forEach(function(o,i){n+='<p class="result-date">'+o+"요일: </p>",e[i].forEach(function(o){return null===o[0]?!1:(o[0]<12?t="오전":12===o[0]?t="오후":(t="오후",o[0]-=12),n+=t+" "+o[0]+"시부터 ~ ",o[1]<12?t="오전":12===o[1]?t="오후":24===o[1]?(t="밤",o[1]-=12):(t="오후",o[1]-=12),void(n+=t+" "+o[1]+"시까지<br>"))})}),n+="입니다.",o.$result.html(n)},t=function(){o.$con.fadeOut("slow"),history.pushState({mod:"lobby"},"","/lobby/"+c.myInfo.id),wwm.lobby.initModule(o.$con)},r=function(){history.pushState({mod:"room"},"","/room/"+c.rid),o.$con.fadeOut("slow")},l=function(){},a=function(){FB.ui({method:"send",link:"http%3A%2F%2Fwww.nytimes.com%2F2011%2F06%2F15%2Farts%2Fpeople-argue-just-to-win-scholars-assert.html"})},s=function(s){var d=$("#wwm-confirm").html();c=$.extend(c,s),console.log(s,c),wwm.shell.modal.html(d),e(wwm.shell.modal),i(n()),o.$toLobbyBtn.click(t),o.$toRoom.click(r),o.$toKakao.on({click:l,mouseover:function(){this.src="/kakaolink_btn_medium_ov.png"},mouseout:function(){this.src="/kakaolink_btn_medium.png"}}),o.$toFacebook.on({click:a,mouseover:function(){this.src="/facebook_invite_ov.png"},mouseout:function(){this.src="/facebook_invite.png"}}),o.$con.fadeIn("slow")},{initModule:s,info:c}}(),wwm.intro=function(){var o,e,n,i,t,r,l,a,s={},c={phase:0};return r=function(o){s={$con:o,$main:o.find("#intro-main"),$skip:o.find("#skip-intro"),$next:o.find(".next-phase")}},t=function(o,e){e?o.animate({right:"+=4"},500).animate({right:"-=4"},500,function(){t(o,!0)}):o.animate({bottom:"+=4"},500).animate({bottom:"-=4"},500,function(){t(o)})},a=function(){var o=c.phase||parseInt(s.$main.find("div").attr("class").slice(6));switch(o){case 0:s.$main.find(".intro-logo").showSVGLogo(100);break;case 1:t(s.$main.find("#arrow-to-modal"));break;case 2:s.$main.find("#intro-create-room, #arrow-to-create").css("left",.5*$(window).width()-50),t(s.$main.find("#arrow-to-create")),s.$con.css({height:"250px",bottom:0});break;case 3:s.$con.css({height:"50px",top:0}),t(s.$main.find("#arrow-to-confirm"),!0),s.$main.find(".intro-wrapper").css({background:"white",opacity:.9,top:"70%"});break;case 4:t(s.$main.find("#arrow-to-aside")),s.$main.find(".intro-wrapper").css({background:"white",opacity:.9,top:"125%"});break;case 5:t(s.$main.find("#arrow-to-result"),!0),s.$con.css({height:"50px"}),s.$main.find(".intro-wrapper").css({background:"white",opacity:.9,top:"50%"});break;case 6:s.$con.css({top:"auto",background:"white",textAlign:"center"}),s.$main.find(".intro-wrapper").css({background:"white",opacity:.9})}},n=function(){var o,e=++c.phase;console.log("toFirstPhase",e),o=$("#wwm-phase-"+e).html(),s.$main.html(o),a()},e=function(){console.log("skipIntro"),$(this).is(":checked")&&(localStorage.first="false",wwm.shell.intro.fadeOut("slow"),wwm.model.introDone(userInfo.id))},l=function(){localStorage.first="false",wwm.shell.intro.fadeOut("slow"),wwm.model.introDone(userInfo.id)},i=function(o){var e,i=(new Spinner).spin(),t=$("#room-title").val(),r=$("#room-limit").val(),l=$("#room-password").val(),a=userInfo.id.toString(),c=userInfo.picture,d={rid:(new Date).getTime().toString().slice(0,-4),title:t,maker:a,limit:r,picture:c,password:l,members:JSON.stringify([{id:userInfo.id,name:userInfo.name,picture:userInfo.picture,confirm:!1}])};return console.log("intro createroom",d),o.preventDefault(),s.$con.append(i.el),t?(console.log("createroom data",d),e=wwm.model.createRoom(d),e.done(function(o){console.log(o),d.current=1,wwm.room.initModule(d,"create"),wwm.shell.modal.fadeOut("slow")}),e.fail(function(o){console.log(o),alert("방 생성에러! 콘솔확인")}),e.always(function(){$(i.el).remove()}),void n()):($(i.el).remove(),void alert("제목을 입력하세요."))},o=function(){var o=$("#wwm-intro").html();wwm.shell.intro.html(o).fadeIn("slow"),r(wwm.shell.intro),a(),s.$skip.change(e),s.$next.click(n),s.$main.on("click","#intro-show-modal",function(){console.log("intro showModal"),wwm.modal.initModule($("#wwm-create-modal").html()),n()}),s.$main.on("click","#intro-create-room",i),s.$main.on("click","#intro-confirm",function(){wwm.room.confirmTable(userInfo.id,wwm.room.info.rid),n()}),s.$main.on("click","#intro-aside",function(){wwm.room.toggleAside(),setTimeout(wwm.room.toggleAside,3e3),n()}),s.$main.on("click","#intro-result",function(){wwm.lobby.showResult(wwm.room.info.rid),n()}),s.$main.on("click","#intro-end",function(){l()})},{initModule:o}}(),wwm.lobby=function(){"use strict";var o,e,n,i,t,r,l,a,s,c,d,m,f=io();return t=function(){wwm.modal.initModule($("#wwm-create-modal").html())},e=function(){var e=(new Spinner).spin(),n=wwm.model.getRoomList(userInfo.id);o.$list.append(e.el),n.done(function(o){i(o)}),n.fail(function(e){return"no_room"===e?void o.$list.html('<span class="info-message">방이 없습니다. 방을 만들어보세요.</span>'):(console.log(e),void o.$list.html(e.responseText))}),n.always(function(){$(e.el).remove()})},n=function(e){var n,t=e,r=(new Spinner).spin();"string"!=typeof e&&(t=$(this).parent().prev().val().trim(),e.preventDefault()),history.pushState({mod:"search",query:t},"","/search/"+t),console.log("query",t),o.$list.append(r.el),n=wwm.model.searchList(t),n.done(function(o){i(o)}),n.fail(function(e){return"no_room"===e?void o.$list.html('<span class="info-message">검색 결과가 없습니다.</span>'):(console.log(e),void o.$list.html(e.responseText))}),n.always(function(){$(r.el).remove()})},i=function(e){var n,i,t,r,l=$(document.createDocumentFragment()),a=$("#wwm-room-list").html();e.forEach(function(o){n=dust.loadSource(dust.compile(a)),i=o.password||!1,t=!1,i&&o.members.some(function(o){return o.id===userInfo.id?t=!0:!1}),r={rid:o.rid,picture:o.picture,title:o.title,current:o.members.length,limit:o.limit,vacant:o.limit-o.members.length,result:o.result,password:i,unlocked:t},dust.render(n,r,function(o,e){l.append(e)})}),o.$list.html(l)},r=function(){history.pushState({mod:"logout"},"","/"),delete window.userInfo,localStorage.removeItem("login"),localStorage.removeItem("loginType"),wwm.login.initModule()},l=function(e){var n,i,t,r=$(this),l=(new Spinner).spin();return o.$list.append(l.el),"string"!=typeof e&&(e=$(this).data("rid"),$(this).has(".locked").length&&(t=prompt("비밀번호",""),console.log(t),null===t||""===t.trim()))?void $(l.el).remove():(console.log(e),i={rid:e,pw:t,pid:userInfo.id,name:userInfo.name,picture:userInfo.picture},n=wwm.model.enterRoom(i),n.done(function(o){return console.log(o),"no_room"===o?void alert("방이 없습니다"):"full"===o?void alert("방이 다 찼습니다."):"wrong_password"===o?void alert("비밀번호가 틀렸습니다."):"ban"===o?void alert("강퇴당한 방에는 들어갈 수 없습니다."):(o.current=r.find(".current").text(),console.log("enter room post result",o),history.pushState({mod:"room",data:o},"","/room/"+e),void wwm.room.initModule(o,"enter"))}),n.fail(function(o){console.log(o.responseText),alert("오류발생! 콘솔확인")}),void n.always(function(){$(l.el).remove()}))},a=function(){console.log("refreshlist"),e()},s=function(){var e=wwm.model.getUser(userInfo.id),n=JSON.parse(localStorage.login);e.done(function(e){o.$profilePicture.attr("src",e.picture),o.$profileName.text(e.name),userInfo.picture=e.picture,userInfo.name=e.name,n.picture=e.picture,n.name=e.name,localStorage.login=JSON.stringify(n)})},c=function(o){var e,n={};o?(e=wwm.model.getRoomInfo(o),e.done(function(e){"no_room"===e?alert("방이 없습니다"):(history.pushState({mod:"confirm"},"","/result/"+o),n.dayArray=e.day,n.nightArray=e.night,n.rid=e.rid,wwm.confirm.initModule(n))}),e.fail(function(o){console.error(o)})):(o=$(this).parent().data("rid"),history.pushState({mod:"confirm"},"","/result/"+o),wwm.confirm.initModule(n))},d=function(e){o={$con:e,$showCreateroom:e.find("#show-createroom-modal"),$searchroomBtn:e.find("#searchroom-btn"),$main:e.find("#lobby-main"),$list:e.find("#rooms"),$logout:e.find("#logout-btn"),$refresh:e.find("#refresh-list"),$refreshProfile:e.find("#refresh-profile"),$result:e.find(".result"),$profilePicture:e.find("#profile-picture"),$profileName:e.find("#profile-name")}},m=function(){var i,m,u,h;localStorage.login||(history.pushState({mod:"login"},"","/login"),wwm.login.initModule()),localStorage.first||(localStorage.first="true"),h=JSON.parse(localStorage.first),h&&wwm.intro.initModule($("#wwm-intro").html()),window.userInfo||(window.userInfo=JSON.parse(localStorage.login)),u=$("#wwm-lobby").text(),i=userInfo.name,m=userInfo.picture,dust.render(dust.loadSource(dust.compile(u)),{name:i,picture:m},function(i,m){i?(console.log(i),alert("rendering error! 콘솔 확인")):(wwm.shell.view.html(m).fadeIn("slow"),d(wwm.shell.view),o.$con.showSVGLogo(100),e(),o.$showCreateroom.click(t),o.$searchroomBtn.click(n),o.$logout.click(r),o.$refresh.click(a),o.$refreshProfile.click(s),o.$list.on("click",".room",l),o.$list.on("click",".result",c),f.on("titleChanged",function(o){var e=$(".room"),n=e.map(function(o,e){$(e).data("rid")}).get();n.every(function(n,i){return o.rid===n?(e.eq(i).find(".title").text(o.title),!1):!0})}),f.on("currentChanged",function(o){var e=$(".room"),n=e.map(function(o,e){$(e).data("rid")}).get();n.every(function(n,i){return o.rid===n?(e.eq(i).find(".current").text(o.number),!1):!0})}),f.on("limitChanged",function(o){var e=$(".room"),n=e.map(function(o,e){$(e).data("rid")}).get();n.every(function(n,i){return o.rid===n?(e.eq(i).find(".total").text(o.number),!1):!0})}))})},{initModule:m,enterRoom:l,showResult:c,searchRoom:n,refreshList:a}}(),wwm.login=function(){"use strict";var o,e,n,i,t,r,l,a,s;return e=function(){var o={id:"123456789",name:"관리자",picture:"//graph.facebook.com/874512615962577/picture"},e=wwm.model.join(o);e.fail(function(o){alert("가입 오류 발생!"),console.log(o.responseText)}),history.pushState({mod:"login",data:o,type:"local"},"","/lobby/123456789"),window.userInfo=o,localStorage.login=JSON.stringify(o),localStorage.loginType="local",wwm.lobby.initModule(wwm.shell.view)},n=function(){var o={id:"987654321",name:"테스터",picture:"http://th-p.talk.kakao.co.kr/th/talkp/wkkZf8zHlk/lxr9VefTlrfUr7FAzsAgJk/ljh2mh_640x640_s.jpg"},e=wwm.model.join(o);e.fail(function(o){alert("가입 오류 발생!"),console.log(o.responseText)}),history.pushState({mod:"login",data:o,type:"local2"},"","/lobby/987654321"),window.userInfo=o,localStorage.login=JSON.stringify(o),localStorage.loginType="local2",wwm.lobby.initModule(wwm.shell.view)},i=function(){Kakao.Auth.login({success:function(){Kakao.API.request({url:"/v1/user/me",success:function(o){console.log(o),Kakao.API.request({url:"/v1/api/talk/profile",success:function(e){e=$.extend(e,o),l(e),console.log(e)},fail:function(o){alert(JSON.stringify(o))}})},fail:function(o){alert(JSON.stringify(o))}})},fail:function(o){alert(JSON.stringify(o))}})},l=function(o){var e;console.log(JSON.stringify(o)),o.name=o.nickName,o.picture=o.profileImageURL,o.thumb=o.thumbnailURL,e=wwm.model.join(o),e.fail(function(o){alert("가입 오류 발생!"),console.log(o.responseText)}),history.pushState({mod:"login",data:o,type:"kakao"},"","/lobby/"+o.id),window.userInfo=o,localStorage.login=JSON.stringify(o),localStorage.loginType="kakao",wwm.lobby.initModule(wwm.shell.view)},t=function(){FB.login(function(o){"connected"===o.status?FB.api("/me",a):"not_authorized"===o.status?alert("Please log log into this app."):alert("Please log into Facebook.")})},a=function(o){var e;console.log(JSON.stringify(o)),o.picture="//graph.facebook.com/"+o.id+"/picture",e=wwm.model.join(o),e.fail(function(o){alert("가입 오류 발생!"),console.log(o.responseText)}),history.pushState({mod:"login",data:o,type:"facebook"},"","/lobby/"+o.id),window.userInfo=o,localStorage.login=JSON.stringify(o),localStorage.loginType="facebook",wwm.lobby.initModule(wwm.shell.view)},r=function(e){o={$con:e,$logo:e.find("#login-logo"),$wrapper:e.find("#login-wrapper"),$kakaoLogin:e.find("#kakao-login-btn"),$fbLogin:e.find("#fb-login-btn"),$localhost:e.find("#localhost-login"),$localhost2:e.find("#localhost2-login")}},s=function(){wwm.shell.view.html($("#wwm-login").html()),r(wwm.shell.view),o.$logo.showSVGLogo(100),o.$logo.animate({height:"70%"}),o.$wrapper.fadeIn("slow"),o.$kakaoLogin.on({click:i,mouseover:function(){this.src="/kakao_account_login_btn_medium_narrow_ov.png"},mouseout:function(){this.src="/kakao_account_login_btn_medium_narrow.png"}}),o.$fbLogin.on({click:t,mouseover:function(){this.src="/facebook_ov.png"},mouseout:function(){this.src="/facebook.png"}}),o.$localhost.click(e),o.$localhost2.click(n)},{initModule:s}}(),wwm.modal=function(){"use strict";var o,e,n,i,t;return e=function(e){o={$con:e,$close:e.find(".modal-close"),$roomTitle:e.find("#room-title"),$limit:e.find("#room-limit"),$password:e.find("#room-password"),$createRoom:e.find("#create-room-btn"),$reportTitle:e.find("#report-title"),$reportContent:e.find("#report-content"),$report:e.find("#report-btn")}},n=function(o){o.preventDefault(),wwm.shell.modal.fadeOut("slow")},i=function(e){var n,i=(new Spinner).spin(),t=o.$roomTitle.val().trim(),r=o.$limit.val(),l=o.$password.val().trim()||null,a=userInfo.id.toString(),s=userInfo.picture,c={rid:(new Date).getTime().toString().slice(0,-4),title:t,maker:a,limit:r,picture:s,password:l,members:JSON.stringify([{id:userInfo.id,name:userInfo.name,picture:userInfo.picture,confirm:!1}])};return e.preventDefault(),o.$con.append(i.el),t?(console.log("createroom data",c),n=wwm.model.createRoom(c),n.done(function(o){console.log(o),c.current=1,wwm.room.initModule(c,"create"),wwm.shell.modal.fadeOut("slow")}),n.fail(function(o){console.log(o),alert(o)}),void n.always(function(){$(i.el).remove()})):($(i.el).remove(),void alert("제목을 입력하세요."))},t=function(t){wwm.shell.modal.html(t),e(wwm.shell.modal),wwm.shell.modal.fadeIn("slow"),o.$roomTitle.focus(),o.$close.click(n),o.$createRoom.click(i)},{initModule:t}}(),wwm.room=function(){"use strict";var o,e,n,i,t,r,l,a,s,c,d,m,f,u,h,g,p,w,y,b,v,k,I,L,S,C,T,A,x,M,_,O,N,j,q,D,E,R={now:"day",dayArray:null,nightArray:null,memberList:[],myInfo:{id:null,name:null,confirm:!1,personColor:0},onlineList:new Array(8),maker:0,rid:null,title:null,picture:null,limit:0,current:0,event:!1},F={colorList:["red","orange","yellow","yellowgreen","skyblue","purple","violet","pink"]},J=io();return e=function(e){o={$con:e,$picture:e.find("#room-header img"),$table:e.find("table"),$dayTable:e.find("#day-table"),$nightTable:e.find("#night-table"),$thDay:e.find("#day-table tr:first-child, #night-table tr:first-child").find("th"),$thTime:e.find("#day-table, #night-table").find("tr").find("th:first-child"),$memberList:e.find("#member-list"),$toggleTable:e.find("#toggle-table"),$toLobbyBtn:e.find("#back-to-lobby"),$quitBtn:e.find("#quit"),$admin:e.find("#manage-btn, #invite-btn"),$explodeRoom:e.find("#explode-room"),$changeLimit:e.find("#change-limit-btn"),$changeTitle:e.find("#change-room-title"),$roomTitle:e.find("#title"),$report:e.find("#report-error"),$roomPeople:e.find("#room-people-info"),$sendChat:e.find("#send-chat"),$chatbox:e.find("#chatbox"),$chatWrap:e.find("#chat-wrapper"),$chatList:e.find("#chat-list"),$chatToggler:e.find(".chat-toggler"),$confirm:e.find("#confirm-calendar"),$refresh:e.find("#refresh-calendar"),$allConfirmed:e.find("#all-confirmed"),$kakaoInvite:e.find("#kakao-invite"),$fbInvite:e.find("#fb-invite"),$aside:e.find("#room-aside"),$asideFooter:e.find("#aside-footer"),$asideToggler:e.find("#show-aside, #close-aside")}},n=function(o){var e,i=new Array(o||0),t=[].slice.call(arguments,1);if(arguments.length>1)for(e=0;o>e;e++)i[e]=n.apply(this,t);else if(1==arguments.length)for(e=0;e<i.length;e++)i[e]=[];return i},i=function(o){var e,n=[];return console.log("tableToArray"),o.forEach(function(o){e=[o.parentNode.rowIndex-1,o.cellIndex-1],n.push(e)}),console.log("tableToArray",n),n},t=function(e,n,i,t){var r,l,a,s,c,d;console.log("arrayToTable",e,n,i,t),"day"===i?(l=o.$dayTable,r=R.dayArray):(l=o.$nightTable,r=R.nightArray),e.forEach(function(o){a=l.find("tr").eq(o[0]+1).find("td").eq(o[1]),d=r[o[0]][o[1]],t?(d.push(n),s=a.find("div").eq(n),s.addClass(F.colorList[n]),a.addClass("busy")):(c=d.indexOf(n),c>-1&&d.splice(c,1),s=a.find("div").eq(n),s.removeClass(F.colorList[n]),d.length||a.removeClass("busy")),r[o[0]][o[1]]=d})},r=function(){var e,n,i=[R.dayArray,R.nightArray];console.log("renderTable",R.dayArray,R.nightArray),i.forEach(function(i){i.forEach(function(i,t){i.forEach(function(i,r){i.forEach(function(i){e=o.$dayTable.find("tr").eq(t+1).find("td").eq(r).addClass("busy"),n=e.find("div").eq(i).addClass(F.colorList[i])})})})})},M=function(o){var e,n=[R.dayArray,R.nightArray];console.log("removeSchedule",R.dayArray,R.nightArray),n.forEach(function(n){n.forEach(function(n){n.forEach(function(n){e=n.indexOf(o),e>-1&&(n.splice(e,1),n.forEach(function(e,i){e>o&&n[i]--}))})})}),r()},l=function(){var e=$("#wwm-member-list").html();console.log("showMembers",R.memberList),o.$memberList.find("ul").empty(),R.memberList.forEach(function(n,i){dust.render(dust.loadSource(dust.compile(e)),{id:n.id,color:F.colorList[i],name:n.name,picture:n.picture},function(e,n){e?o.$memberList.find("ul").html(e):o.$memberList.find("ul").append(n)})}),s()},a=function(e){var n=$("#wwm-member-list").html();console.log("newMember",e,e.id,R.memberList),R.memberList.push({id:e.id,name:e.name,picture:e.picture,confirm:!1}),dust.render(dust.loadSource(dust.compile(n)),{id:e.id,color:c(id).color,name:e.name,picture:e.picture},function(e,n){e?o.$memberList.find("ul").html(e):o.$memberList.find("ul").append(n)}),s()},s=function(){var e;console.log("showOnline onlineList",R.onlineList),R.memberList.forEach(function(n,i){e=o.$memberList.find("li").eq(i),R.onlineList[i]?0!==e.has(".offline").length&&e.find(".offline").toggleClass("offline online"):0!==e.has(".online").length&&e.find(".online").toggleClass("online offline")})},c=function(o){var e,n={};return console.log("findInfo",o),R.memberList.forEach(function(i){o==i.id&&(n.personColor=e,n.name=i.name,n.color=F.colorList[e])}),n},d=function(o,e){var n,i;return console.log(typeof o),"string"==typeof o?n=o:(n=$(this).prev().val(),e=o.data.rid,o.preventDefault()),console.log("banPerson",arguments),n==R.maker?void alert("자기 자신을 강퇴시키면 안 되겠죠?"):(i=wwm.model.ban(n,e),i.done(function(){J.emit("ban",{id:n,order:c(n).personColor})}),void i.fail(function(o){console.log(o),alert("퇴장당하지 않으려고 버티는중! 다시 시도하세요.")}))},m=function(e){var n=$(this).parent().prev().val(),i=wwm.model.changeTitle(R.rid,n);e.preventDefault(),console.log("changeTitle",n),i.done(function(){R.title=n,o.$roomTitle.text(n)}),i.fail(function(o){alert("제목 바꾸기 실패!"),console.log(o)})},f=function(o){var e,n=Number($(this).parent().prev().val());return o.preventDefault(),n!==n?void alert("숫자를 입력해야 합니다."):(console.log("changeLiimit",n),n<R.current?void alert("현재 사람이 설정한 수보다 많습니다."):(e=wwm.model.changeLimit(R.rid,n),e.done(function(){C(n)}),void e.fail(function(o){alert("인원수 바꾸기 실패!"),console.log(o)})))},S=function(e){console.log("changeCurrentNumber",e),R.current+=e,e>0?o.$roomPeople.find(".vacant").first().removeClass("vacant"):o.$roomPeople.find(".fa-child").not(".vacant").last().addClass("vacant"),$("#current-people-limit").val(R.current)},C=function(e){var n,i=R.limit;if(console.log("changeLimitNumber",e),R.limit=e,e>i)for(n=0;e-i>n;n++)o.$roomPeople.append('<i class="fa fa-child vacant"></i>');else for(n=0;i-e>n;n++)o.$roomPeople.find(".vacant").last().remove()},p=function(o){var e=$(this);o.stopPropagation(),console.log("showAdminMenu"),e.parent().hasClass("opened")?e.parent().removeClass("opened"):($(".opened").removeClass("opened"),e.parent().addClass("opened"))},w=function(e){var n=e.data.rid,i=wwm.model.deleteRoom(n,userInfo.id);console.log("room deleteRoom",n),i.done(function(){alert("삭제되었습니다."),wwm.lobby.initModule(o.$con),J.emit("explode",n)}),i.fail(function(o){console.log(o),alert("방 지우기 오류발생")})},y=function(){o.$confirm.hasClass("confirmed")&&(alert("확정 상태가 해제됩니다."),o.$confirm.removeClass("confirmed"),R.myInfo.confirm=!1,J.emit("confirmed",{id:R.myInfo.id,bool:!1}))},u=function(){var o,e=this.cellIndex-1,n=[],i=!0;y(),console.log("onClickDay"),o="day"===R.now?R.dayArray:R.nightArray,o.forEach(function(o,t){-1==o[e].indexOf(R.myInfo.personColor)&&(i=!1,n.push([t,e]))}),i?(n=[],o.forEach(function(o,i){n.push([i,e])}),J.emit("not-busy",{cur:R.now,sid:R.myInfo.personColor,arr:n})):J.emit("busy",{cur:R.now,sid:R.myInfo.personColor,arr:n})},h=function(){var o,e=this.parentNode.rowIndex-1,n=[],i=!0;y(),console.log("onClickTime",e),o="day"===R.now?R.dayArray:R.nightArray,console.log(o[e]),o[e].forEach(function(o,t){-1==o.indexOf(R.myInfo.personColor)&&(i=!1,n.push([e,t]))}),i?(n=[],o[e].forEach(function(o,i){n.push([e,i])}),J.emit("not-busy",{cur:R.now,sid:R.myInfo.personColor,arr:n})):J.emit("busy",{cur:R.now,sid:R.myInfo.personColor,arr:n})},g=function(){var o,e;y(),o="day"===R.now?R.dayArray:R.nightArray,e=o[this.parentNode.rowIndex-1][this.cellIndex-1],console.log("onclickCell",this.parentNode.rowIndex-1,this.cellIndex-1,e),console.log("onclickCell",this.parentNode.rowIndex-1,this.cellIndex-1,e,e.length,R.myInfo.personColor),e?(console.log(e.length,e.indexOf(R.myInfo.personColor)>-1),e.length&&e.indexOf(R.myInfo.personColor)>-1?J.emit("not-busy",{cur:R.now,sid:R.myInfo.personColor,arr:i([this],!1)}):J.emit("busy",{cur:R.now,sid:R.myInfo.personColor,arr:i([this],!0)})):J.emit("busy",{cur:R.now,sid:R.myInfo.personColor,arr:i([this],!0)})},A=function(){var e=o.$chatWrap,n=o.$chatList;e.hasClass("minified")?(e.removeClass("minified"),e.css({height:"100px"}),n.css({height:"100px"}),n.animate({scrollTop:n.scrollHeight},"slow"),$(this).toggleClass("fa-chevron-down fa-chevron-up")):(e.addClass("minified"),e.css({height:"20px"}),n.css({height:"20px"}),n.animate({scrollTop:n.scrollHeight},"slow"),$(this).toggleClass("fa-chevron-down fa-chevron-up"))},b=function(e){console.log("toLobby",e.data.rid),o.$confirm.hasClass("confirmed")?(history.pushState({mod:"lobby"},"","/lobby/"+R.myInfo.id),J.emit("out",{id:R.myInfo.id,rid:e.data.rid}),wwm.lobby.initModule(o.$con)):confirm("확정 버튼을 누르지 않고 나가면 저장되지 않은 사항은 사라집니다.")&&(history.pushState({mod:"lobby"},"","/lobby/"+R.myInfo.id),J.emit("out",{id:R.myInfo.id,rid:e.data.rid}),wwm.lobby.initModule(o.$con))},v=function(e){var n,i,t;console.log("quit",e.data.rid),1===R.current?confirm("혼자 있을 때 방을 나가면 방이 사라집니다.그래도 나가시겠습니까?")&&(t=wwm.model.deleteRoom(e.data.rid,R.myInfo.id),t.done(function(){wwm.lobby.initModule(o.$con)}),t.fail(function(o){console.log(o),alert("방 삭제 실패!")})):R.maker===R.myInfo.id?confirm("지금 나가면 방장이 다른 사람에게 넘어갑니다.")&&(n=R.memberList[1].id,i=R.memberList[1].picture,history.replaceState({mod:"lobby"},"","/lobby/"+R.myInfo.id),J.emit("delegate",{id:R.myInfo.id,order:R.myInfo.personColor,rid:e.data.rid,admin:n,picture:i})):confirm("정말 나가시겠습니까? 잠시 나가는 거면 로비 버튼을 클릭하세요.")&&(history.replaceState({mod:"lobby"},"","/lobby/"+R.myInfo.id),J.emit("quit",{id:R.myInfo.id,order:R.myInfo.personColor,rid:e.data.rid})),wwm.lobby.initModule(o.$con)},T=function(o){var e=$(this).parent().prev().val();o.preventDefault(),console.log("sendChat",R.myInfo.id,e),J.emit("chat",{id:R.myInfo.id,name:R.myInfo.name,color:R.myInfo.personColor,text:e})},x=function(){console.log("refresh",{rid:R.rid,id:R.myInfo.id}),J.on("responseArr",function(o){console.log("socket responseArr"),R.dayArray=o.day,R.nightArray=o.night,r()}),J.emit("requestArr",{rid:R.rid,id:R.myInfo.id})},_=function(e,n){var i,t={};"string"==typeof e?(t.id=e,t.rid=n):t=e.data,t.bool=!R.myInfo.confirm,t.day=R.dayArray,t.night=R.nightArray,console.log("change confirm to",t.bool,t),i=wwm.model.confirm(t),i.done(function(){o.$confirm.hasClass("confirmed")?o.$confirm.removeClass("confirmed"):o.$confirm.addClass("confirmed"),R.myInfo.confirm=t.bool,J.emit("confirmed",{id:R.myInfo.id,bool:t.bool}),console.log(R.dayArray)}),i.fail(function(o){console.log(o),alert("confirm error!")})},L=function(){"day"===R.now?(R.now="night",o.$dayTable.hide(),o.$nightTable.show()):(R.now="day",o.$dayTable.show(),o.$nightTable.hide()),$(this).find("div").toggleClass("tapped")},O=function(){console.log("toConfirmPage",R),history.pushState({mod:"confirm"},"","/result/"+R.rid),wwm.confirm.initModule(R)},N=function(){Kakao.Link.createTalkLinkButton({container:"#kakao-invite",label:"카카오링크 샘플에 오신 것을 환영합니다.",image:{src:"http://dn.api1.kage.kakao.co.kr/14/dn/btqaWmFftyx/tBbQPH764Maw2R6IBhXd6K/o.jpg",width:"300",height:"200"},webButton:{text:"우리 언제 만나",url:"http://whenwemeet.herokuapp.com"},fail:function(){alert("KakaoLink is currently only supported in iOS and Android platforms.")}})},j=function(){FB.ui({method:"send",link:"http%3A%2F%2Fwww.nytimes.com%2F2011%2F06%2F15%2Farts%2Fpeople-argue-just-to-win-scholars-assert.html"})},q=function(){console.log("toggleAside",o.$aside.hasClass("opened")),o.$aside.hasClass("opened")?(o.$aside.removeClass("opened"),o.$aside.css("left","-100%")):(o.$aside.addClass("opened"),o.$aside.css("left","0"))},D=function(){var o=$(this);return console.log("showMemberMenu"),R.maker!==R.myInfo.id?!1:void(o.has(".ban-this-btn").length||(o.append('<span class="ban-this-btn">강퇴</span>'),setTimeout(function(){o.find(".ban-this-btn").fadeOut("slow").remove()},5e3)))},k=function(){wwm.modal.initModule($("#wwm-report").html())},I=function(){console.log("handleEvnet",R.event),R.event||(J.on("out",function(e){console.log(o.$memberList,o.$memberList.find("[data-id="+e+"]")),R.memberList.every(function(o,n){
return o.id==e?(R.onlineList[n]=!1,!1):!0}),s(),console.log("socketout",R.onlineList,R.memberList)}),J.on("quit",function(e){R.memberList.forEach(function(o,n){return o.id==e.id?(R.onlineList.splice(n,1),R.memberList.splice(n,1),!1):!0}),console.log(o.$memberList,o.$memberList.find("[data-id="+e.id+"]")),S(-1),l(),M(e.order),console.log("socket quit",R.onlineList,R.memberList)}),J.on("delegate",function(e){R.memberList.forEach(function(o,n){return o.id==e.id?(R.onlineList.splice(n,1),R.memberList.splice(n,1),!1):!0}),console.log(o.$memberList,o.$memberList.find("[data-id="+e.id+"]")),S(-1),l(),M(e.order),R.maker=e.admin,R.picture=e.picture,o.$picture.attr("src",R.picture),R.myInfo.id===e.admin&&dust.render(dust.loadSource(dust.compile(menu)),{admin:!0},function(e,n){e?console.log(e):o.$admin.replaceWith(n)}),console.log("socket quit",R.onlineList,R.memberList)}),J.on("newMember",function(o){console.log("socket newmember",o),R.onlineList[o.color]=!0,J.emit("uptodateArr",{sid:o.socket,day:R.dayArray,night:R.nightArray,online:R.onlineList}),o.color>=R.current&&(S(1),a(o)),s()}),J.on("uptodateArr",function(o){console.log("socket uptodateArr"),R.dayArray=o.day,R.nightArray=o.night,R.onlineList=o.online,s(),r()}),J.on("chat",function(e){console.log("socket chat",e.id,e.text),o.$chatList.append('<p><span class="'+F.colorList[e.color]+'-text">'+e.name+"</span>: "+e.text+"</p>"),o.$chatbox.val("").focus(),o.$chatList.animate({scrollTop:o.$chatList[0].scrollHeight},"slow")}),J.on("busy",function(o){console.log("socketbusy:",o.arr,o.sid,o.cur),t(o.arr,o.sid,o.cur,!0)}),J.on("not-busy",function(o){console.log("socketnotbusy:",o.arr,o.sid,o.cur),t(o.arr,o.sid,o.cur,!1)}),J.on("requestArr",function(o){console.log("socket requestArr"),J.emit("responseArr",{sid:o.sid,day:R.dayArray,night:R.nightArray})}),J.on("ban",function(e){return R.myInfo.personColor==e.order?(alert("강퇴당하셨습니다..."),void wwm.lobby.initModule(o.$con)):(R.myInfo.personColor>e.order&&R.myInfo.personColor--,alert(c(e.id).name+"님이 강제퇴장 되었습니다. 잘가요!"),R.memberList.every(function(o,n){return e.id==o.id?(R.memberList.splice(n,1),R.onlineList.splice(n,1),!1):!0}),S(-1),M(e.order),l(),void console.log("socket ban"))}),J.on("confirmed",function(e){var n=0;R.memberList.forEach(function(o){o.id==e.id&&(o.confirm=e.bool),o.confirm===!0&&n++}),n==R.memberList.length?o.$allConfirmed.show():o.$allConfirmed.hide(),console.log("socket confirmed")}),J.on("explode",function(){alert("방이 폭파되었습니다. 로비로 이동합니다."),wwm.lobby.initModule(o.$con),console.log("socket explode")}),R.event=!0)},E=function(i){var t,a=$("#wwm-room").text(),s=$("#wwm-admin-menu").html();console.log("room initModule",R.rid),R.title=i.title,R.limit=Number(i.limit),R.rid=i.rid.toString(),R.maker=i.maker.toString(),R.dayArray=i.day||n(12,7),R.nightArray=i.night||n(12,7),console.log(R.dayArray,R.nightArray),R.memberList=Array.isArray(i.members)?i.members:JSON.parse(i.members),R.current=R.memberList.length,R.picture=i.picture,R.myInfo.id=userInfo.id.toString(),R.myInfo.name=userInfo.name,R.memberList.every(function(o,e){return o.id==userInfo.id?(R.myInfo.personColor=e,R.myInfo.confirm=o.confirm,!1):!0}),R.onlineList[R.myInfo.personColor]=!0,J.emit("enter",{id:R.myInfo.id,rid:R.rid,name:R.myInfo.name,color:R.myInfo.personColor,picture:userInfo.picture}),t={name:R.myInfo.name,title:R.title,current:R.current,limit:R.limit,members:R.memberList,picture:R.picture,vacant:R.limit-R.current},R.myInfo.id==R.maker&&(t.admin=!0),dust.render(dust.loadSource(dust.compile(a)),t,function(n,i){return n?void wwm.shell.view.html(n):(wwm.shell.view.html(i),void dust.render(dust.loadSource(dust.compile(s)),t,function(n,i){var t=0;return n?void wwm.shell.view.html(n):(console.log(wwm.shell.view,i),wwm.shell.view.find("#aside-footer").prepend(i),e(wwm.shell.view),r(),R.myInfo.confirm&&o.$confirm.addClass("confirmed"),R.memberList.forEach(function(o){o.confirm===!0&&t++}),t===R.memberList.length?o.$allConfirmed.show():o.$allConfirmed.hide(),o.$roomTitle.addClass(F.colorList[R.myInfo.personColor]+"-text"),l(),I(),o.$table.find("td").click(g),o.$explodeRoom.click({rid:R.rid},w),o.$toLobbyBtn.click({rid:R.rid},b),o.$toggleTable.click(L),o.$admin.click(p),o.$changeLimit.click({rid:R.rid},f),o.$changeTitle.click({rid:R.rid},m),o.$sendChat.click(T),o.$thDay.click(u),o.$memberList.on("click","li",D),o.$memberList.on("click",".ban-this-btn",function(){var o=$(this).parent().data("id");d(o.toString(),R.rid)}),o.$thTime.click(h),o.$confirm.click({id:R.myInfo.id,rid:R.rid},_),o.$chatToggler.click(A),o.$refresh.click(x),o.$allConfirmed.click(O),o.$quitBtn.click({id:R.myInfo.id,rid:R.rid},v),o.$asideToggler.click(q),o.$report.click(k),o.$kakaoInvite.on({click:N,mouseover:function(){this.src="/kakaolink_btn_medium_ov.png"},mouseout:function(){this.src="/kakaolink_btn_medium.png"}}),void o.$fbInvite.on({click:j,mouseover:function(){this.src="/facebook_invite_ov.png"},mouseout:function(){this.src="/facebook_invite.png"}}))}))})},{initModule:E,info:R,confirmTable:_,toggleAside:q}}();