window.onerror=function(o,e,n,i,r){"string"==typeof o&&o.indexOf("Script error.")>-1||console.log("Error: ",o," Script: "+e+" Line: "+n+" Column: "+i+" StackTrace: "+r)},$.fn.showSVGLogo=function(o){var e=$($("#wwm-svg-logo").html());return e.width(o||"100%"),this.prepend(e),this},$.fn.showCanvasLogo=function(o){function e(o,e,n,i,r){var t=e*(Math.sqrt(3)/2);o.fillStyle=r,o.beginPath(),o.moveTo(n,i-t/2),o.lineTo(n-e/2,i+t/2),o.lineTo(n+e/2,i+t/2),o.lineTo(n,i-t/2),o.shadowOffsetX=1,o.shadowOffsetY=3,o.shadowBlur=1,o.shadowColor="rgb(204, 204, 204)",o.fill()}function n(o,e,n,i,r){var t=e*(Math.sqrt(3)/2);o.fillStyle=r,o.beginPath(),o.moveTo(n,i-t/2),o.lineTo(n-e,i-t/2),o.lineTo(n-e/2,i+t/2),o.lineTo(n,i-t/2),o.shadowOffsetX=1,o.shadowOffsetY=3,o.shadowBlur=1,o.shadowColor="rgb(204, 204, 204)",o.fill()}var i=$($("#wwm-canvas-logo").html()),r=i[0],t=r.getContext("2d");return e(t,50,r.width/2+13,r.height/2,"magenta"),n(t,50,r.width/2+7,r.height/2,"cyan"),e(t,50,r.width/2-16,r.height/2-49,"yellow"),n(t,50,r.width/2+36,r.height/2+49,"greenyellow"),i.width(o||"100%"),this.prepend(i),this};var wwm=function(){function o(){wwm.model.initModule(),wwm.shell.initModule()}return{initModule:o}}();wwm.model=function(){var o=function(o){var e=$.Deferred();return $.ajax("/join",{data:o,type:"post",contentType:"application/x-www-form-urlencoded;charset=utf-8"}).done(function(o){e.resolve(o)}).fail(function(o){e.reject(o)}),e.promise()},e=function(o){var e=$.Deferred();return $.get("/rooms/"+o).done(function(o){0===o.length?e.reject("no_room"):e.resolve(o)}).fail(function(o){e.reject(o)}),e.promise()},n=function(o){var e=$.Deferred();return $.get("/member/"+o).done(function(o){e.resolve(o)}).fail(function(o){e.reject(o)}),e.promise()},i=function(o){var e=$.Deferred();return $.get("/search/"+o).done(function(o){0===o.length&&e.reject("no_room"),e.resolve(o)}).fail(function(o){e.reject(o)}),e.promise()},r=function(o,e){var n=$.Deferred();return $.post("/ban/"+o,{rid:e}).done(function(o){console.log(o),n.resolve(o)}).fail(function(o){console.log(o),n.reject(o)}),n.promise()},t=function(){},l=function(o,e){var n=$.Deferred();return $.post("/changeroom/"+o,{title:e}).done(function(o){console.log(o),n.resolve(o)}).fail(function(o){console.log(o),n.reject(o)}),n.promise()},a=function(o,e){var n=$.Deferred();return $.post("/changeroom/"+o,{limit:e}).done(function(o){console.log(o),n.resolve(o)}).fail(function(o){console.log(o),n.reject(o)}),n.promise()},s=function(o){var e=$.Deferred(),n=o.rid;return o.day=JSON.stringify(o.day),o.night=JSON.stringify(o.night),console.log("confirm model",o),$.post("/confirm/"+n,o).done(function(o){console.log(o),e.resolve(o)}).fail(function(o){console.log("confirmerror",o),e.reject(o)}),e.promise()},d=function(o){var e=$.Deferred(),i=n(o.maker);return i.done(function(n){if(n.roomcount>=3){var i="방은 최대 세 개까지 만들 수 있습니다.";e.reject(i)}else $.post("/addroom/"+o.rid,o).done(function(o){e.resolve(o)}).fail(function(o){console.log(o),e.reject(o)})}),i.fail(function(o){console.log(o),e.reject(o)}),e.promise()},c=function(o,e){var n=$.Deferred();return $.post("/deleteroom/"+o,{maker:e}).done(function(o){if(console.log(o),"no_room"===o){var e="심각한 오류! 방장이 아닙니다.";n.reject(e)}n.resolve(o)}).fail(function(o){n.reject(o)}),n.promise()},m=function(o){var e=$.Deferred();return $.post("/roominfo/"+o).done(function(o){if(console.log(o),"no_room"===o){var n="심각한 오류! 방장이 아닙니다.";e.reject(n)}e.resolve(o)}).fail(function(o){e.reject(o)}),e.promise()},f=function(){localStorage.login?window.userInfo=JSON.parse(localStorage.login):window.userInfo={}};return{initModule:f,createRoom:d,getRoomList:e,getUser:n,enterRoom:t,deleteRoom:c,ban:r,changeTitle:l,changeLimit:a,searchList:i,confirm:s,join:o,getRoomInfo:m}}(),wwm.shell=function(){var o={$con:$("#whenwemeet"),$view:$("#view"),$modal:$("#modal"),$logo:$("#logo")},e=function(o){var e=o.originalEvent.state,n=e.mod;switch(console.log("onpopstate",n),n){case"login":window.userInfo=e.data,localStorage.login=JSON.stringify(e.data),localStorage.loginType=e.type,wwm.lobby.initModule();break;case"directlogin":wwm.login.initModule();break;case"lobby":wwm.lobby.initModule();break;case"intro":wwm.modal.initModule($("#wwm-intro").html());break;case"search":wwm.lobby.showSearchResult(e.data);break;case"logout":delete window.userInfo,localStorage.removeItem("login"),localStorage.removeItem("loginType"),wwm.login.initModule();break;case"room":wwm.room.initModule(e.data,"enter");break;case"confirm":break;default:wwm.shell.initModule()}},n=function(){console.log("login",localStorage.login),console.log("first",localStorage.first),$(window).on("popstate",e);var o=localStorage.login&&JSON.parse(localStorage.login),n=localStorage.first&&JSON.parse(localStorage.first);n&&(history.pushState({mod:"intro"},"","/intro"),wwm.modal.initModule($("#wwm-intro").html())),o?(history.pushState({mode:"lobby",id:userInfo.id},"","/lobby/"+userInfo.id),wwm.lobby.initModule()):(history.pushState({mode:"directlogin"},"","/login"),wwm.login.initModule())};return{initModule:n,view:o.$view,modal:o.$modal,logo:o.$logo}}(),wwm.confirm=function(){function o(o){n={$con:o,$toLobby:o.find("#to-lobby"),$toRoom:o.find("#to-room"),$toKakao:o.find("#result-to-kakao"),$toFacebook:o.find("#result-to-fb"),$result:o.find("#result")}}function e(){var o,e,n=[[null,null]],r=[[null,null]],t=[[null,null]],l=[[null,null]],a=[[null,null]],s=[[null,null]],d=[[null,null]],c=[n,r,t,l,a,s,d];for(o=0;7>o;o++){var m=0;for(e=0;12>e;e++)console.log(e,0===i.dayArray[e][o].length),0===i.dayArray[e][o].length&&(console.log(null===c[o][m][0]),null===c[o][m][0]?(c[o][m][0]=e,c[o][m][1]=c[o][m][0]+1):(console.log(c[o][m][1]===e),c[o][m][1]===e?c[o][m][1]=e+1:c[o][++m]=[e,e+1])),console.log(c[o],m);for(e=0;12>e;e++)0===i.nightArray[e][o].length&&(null===c[o][m][0]?(c[o][m][0]=e+12,c[o][m][1]=c[o][m][0]+1):c[o][m][1]===e+12?c[o][m][1]=e+13:c[o][++m]=[e+12,e+13]),console.log(c[o],m)}return c}var n,i={},r=function(o){for(var e="가능한 시간은<br>",i=["일","월","화","수","목","금","토"],r=0;7>r;r++){e+=i[r]+"요일:<br>";for(var t=0;t<o[r].length;t++){var l="";o[r][t][0]<12?l="오전":12===o[r][t][0]?l="오후":24===o[r][t][0]?(l="밤",o[r][t][0]-=12):(l="오후",o[r][t][0]-=12),e+=l+" "+o[r][t][0]+"시부터 ~ ",o[r][t][1]<12?l="오전":12===o[r][t][1]?l="오후":24===o[r][t][1]?(l="밤",o[r][t][1]-=12):(l="오후",o[r][t][1]-=12),e+=l+" "+o[r][t][1]+"시까지<br>"}}e+="입니다.",n.$result.html(e)},t=function(){n.$con.fadeOut("slow"),history.pushState({mod:"lobby"},"","/lobby/"+i.myInfo.id),wwm.lobby.initModule(n.$con)},l=function(){history.pushState({mod:"room"},"","/room/"+i.rid),n.$con.fadeOut("slow")},a=function(){},s=function(){FB.ui({method:"send",link:"http%3A%2F%2Fwww.nytimes.com%2F2011%2F06%2F15%2Farts%2Fpeople-argue-just-to-win-scholars-assert.html"})},d=function(d){i=$.extend(i,d),console.log(d,i);var c=$("#wwm-confirm").html();wwm.shell.modal.html(c),o(wwm.shell.modal);var m=e();r(m),n.$toLobby.click(t),n.$toRoom.click(l),n.$toKakao.on({click:a,mouseover:function(){this.src="/kakaolink_btn_medium_ov.png"},mouseout:function(){this.src="/kakaolink_btn_medium.png"}}),n.$toFacebook.on({click:s,mouseover:function(){this.src="/facebook_invite_ov.png"},mouseout:function(){this.src="/facebook_invite.png"}}),n.$con.fadeIn("slow")};return{initModule:d,info:i}}(),wwm.lobby=function(){function o(){wwm.modal.initModule($("#wwm-createroom-modal").html())}function e(){var o=(new Spinner).spin();m.$list.append(o.el);var e=$(document.createDocumentFragment()),n=wwm.model.getRoomList(userInfo.id);n.done(function(o){for(var n=0;n<o.length;n++){var i=o[n],r=$("#wwm-room-list").html(),t=dust.loadSource(dust.compile(r)),l=i.password||!1,a=!1;if(l)for(var s=0;s<i.members.length;s++)if(i.members[s].id==userInfo.id){a=!0;break}var d={rid:i.rid,picture:i.picture,title:i.title,current:i.members.length,limit:i.limit,result:i.result,password:l,unlocked:a};dust.render(t,d,function(o,n){e.append(n)})}m.$list.html(e)}),n.fail(function(o){return"no_room"===o?void m.$list.html('<span class="info-message">방이 없습니다. 방을 만들어보세요.</span>'):(console.log(o),void m.$list.html(o.responseText))}),n.always(function(){$(o.el).remove()})}function n(o){o.preventDefault();var e=$(this).parent().prev().val().trim();console.log("query",e);var n=(new Spinner).spin();m.$list.append(n.el);var r=wwm.model.searchList(e);r.done(function(o){history.pushState({mod:"search",data:o},"","/search/"+e),i(o)}),r.fail(function(o){return"no_room"===o?void m.$list.html('<span class="info-message">검색 결과가 없습니다.</span>'):(console.log(o),void m.$list.html(o.responseText))}),r.always(function(){$(n.el).remove()})}function i(o){for(var e=$(document.createDocumentFragment()),n=0;n<o.length;n++){var i=o[n],r=$("#wwm-room-list").html(),t=dust.loadSource(dust.compile(r)),l=i.password||!1,a=!1;if(l)for(var s=0;s<i.members.length;s++)if(i.members[s].id==userInfo.id){a=!0;break}var d={rid:i.rid,picture:i.picture,title:i.title,current:i.members.length,limit:i.limit,result:i.result,password:l,unlocked:a};console.log("parser",d,l),dust.render(t,d,function(o,n){console.log(r,t,n),e.append(n)})}m.$list.html(e)}function r(){history.pushState({mod:"logout"},"","/"),delete window.userInfo,localStorage.removeItem("login"),localStorage.removeItem("loginType"),wwm.login.initModule()}function t(o){var e,n=$(this),i=(new Spinner).spin();if(m.$list.append(i.el),console.log(o),"string"!=typeof o&&(o=$(this).data("rid"),$(this).has(".locked").length&&(e=prompt("비밀번호",""),console.log(e),null===e||""===e.trim())))return void $(i.el).remove();var r=$.post("/enterroom/"+o,{pw:e,pid:userInfo.id,name:userInfo.name,picture:userInfo.picture});r.done(function(e){return"no_room"===e?void alert("방이 없습니다"):"wrong_password"===e?void alert("비밀번호가 틀렸습니다."):"ban"===e?void alert("강퇴당한 방에는 들어갈 수 없습니다."):(e.current=n.find(".current").text(),console.log("enter room post result",e),history.pushState({mod:"room",data:e},"","/room/"+o),void wwm.room.initModule(e,"enter"))}).fail(function(o){console.log(o.responseText),alert("오류발생! 콘솔확인")}).always(function(){$(i.el).remove()})}function l(){console.log("refreshlist"),e()}function a(){var o=wwm.model.getUser(userInfo.id);o.done(function(o){m.$profilePicture.attr("src",o.picture),m.$profileName.text(o.name),userInfo.picture=o.picture,userInfo.name=o.name;var e=JSON.parse(localStorage.login);e.picture=o.picture,e.name=o.name,localStorage.login=JSON.stringify(e)})}function s(o){o?$.post("/roominfo/"+o).done(function(e){if("no_room"===e)return void alert("방이 없습니다");history.pushState({mod:"confirm"},"","/result/"+o);var n={};n.dayArray=e.day,n.nightArray=e.night,n.rid=e.rid,wwm.confirm.initModule(n)}).fail(function(o){console.error(o)}):(o=$(this).parent().data("rid"),history.pushState({mod:"confirm"},"","/result/"+o),wwm.confirm.initModule(data))}function d(o){m={$con:o,$logo:o.find("#lobby-logo"),$showCreateroom:o.find("#show-createroom-modal"),$searchroomBtn:o.find("#searchroom-btn"),$list:o.find("#rooms"),$logout:o.find("#logout-btn"),$refresh:o.find("#refresh-list"),$refreshProfile:o.find("#refresh-profile"),$result:o.find(".result"),$profilePicture:o.find("#profile-picture"),$profileName:o.find("#profile-name")}}function c(){localStorage.login||(history.pushState({mod:"login"},"","/login"),wwm.login.initModule()),window.userInfo||(window.userInfo=JSON.parse(localStorage.login));var i=$("#wwm-lobby").text(),c=userInfo.name,u=userInfo.picture;dust.render(dust.loadSource(dust.compile(i)),{name:c,picture:u},function(i,c){i?(console.log(i),alert("rendering error! 콘솔 확인")):(wwm.shell.view.html(c).fadeIn("slow"),d(wwm.shell.view),e(),m.$showCreateroom.click(o),m.$searchroomBtn.click(n),m.$logout.click(r),m.$refresh.click(l),m.$refreshProfile.click(a),f.on("titleChanged",function(o){for(var e=$(".room"),n=e.map(function(o,e){$(e).data("rid")}).get(),i=0;i<n.length;i++)if(o.rid===n[i]){e.eq(i).find(".title").text(o.title);break}}),f.on("currentChanged",function(o){for(var e=$(".room"),n=e.map(function(o,e){$(e).data("rid")}).get(),i=0;i<n.length;i++)if(o.rid===n[i]){e.eq(i).find(".current").text(o.number);break}}),f.on("limitChanged",function(o){for(var e=$(".room"),n=e.map(function(o,e){$(e).data("rid")}).get(),i=0;i<n.length;i++)if(o.rid===n[i]){e.eq(i).find(".total").text(o.number);break}}),$(document).on("click",".room",t),$(document).on("click",".result",s))})}var m,f=io();return{initModule:c,showSearchResult:i,enterRoom:t,showResult:s}}(),wwm.login=function(){var o,e=function(){var o={id:"123456789",name:"관리자",picture:"//graph.facebook.com/874512615962577/picture"},e=wwm.model.join(o);e.fail(function(o){alert("가입 오류 발생!"),console.log(o.responseText)}),history.pushState({mod:"login",data:o,type:"local"},"","/lobby/123456789"),window.userInfo=o,localStorage.login=JSON.stringify(o),localStorage.loginType="local",wwm.lobby.initModule(wwm.shell.view)},n=function(){var o={id:"987654321",name:"테스터",picture:"//graph.facebook.com/874512615962577/picture"},e=wwm.model.join(o);e.fail(function(o){alert("가입 오류 발생!"),console.log(o.responseText)}),history.pushState({mod:"login",data:o,type:"local2"},"","/lobby/987654321"),window.userInfo=o,localStorage.login=JSON.stringify(o),localStorage.loginType="local2",wwm.lobby.initModule(wwm.shell.view)},i=function(){Kakao.Auth.login({success:function(){Kakao.API.request({url:"/v1/user/me",success:function(o){console.log(JSON.stringify(o)),o.name=o.properties.nickname,o.picture=o.properties.profile_image;var e=wwm.model.join(o);e.fail(function(o){alert("가입 오류 발생!"),console.log(o.responseText)}),history.pushState({mod:"login",data:o,type:"kakao"},"","/lobby/"+o.id),window.userInfo=o,localStorage.login=JSON.stringify(o),localStorage.loginType="kakao",wwm.lobby.initModule(wwm.shell.view)},fail:function(o){alert(JSON.stringify(o))}})},fail:function(o){alert(JSON.stringify(o))}})},r=function(){FB.login(function(o){"connected"===o.status?FB.api("/me",function(o){console.log(JSON.stringify(o)),o.picture="//graph.facebook.com/"+o.id+"/picture";var e=wwm.model.join(o);e.fail(function(o){alert("가입 오류 발생!"),console.log(o.responseText)}),history.pushState({mod:"login",data:o,type:"facebook"},"","/lobby/"+o.id),window.userInfo=o,localStorage.login=JSON.stringify(o),localStorage.loginType="facebook",wwm.lobby.initModule(wwm.shell.view)}):"not_authorized"===o.status?alert("Please log log into this app."):alert("Please log into Facebook.")})},t=function(e){o={$con:e,$logo:e.find("#login-logo"),$wrapper:e.find("#login-wrapper"),$kakaoLogin:e.find("#kakao-login-btn"),$fbLogin:e.find("#fb-login-btn"),$localhost:e.find("#localhost-login"),$localhost2:e.find("#localhost2-login")}},l=function(){wwm.shell.view.html($("#wwm-login").html()),t(wwm.shell.view),o.$logo.showSVGLogo(100),o.$logo.animate({height:"70%"}),o.$wrapper.fadeIn("slow"),o.$kakaoLogin.on({click:i,mouseover:function(){this.src="/kakao_account_login_btn_medium_narrow_ov.png"},mouseout:function(){this.src="/kakao_account_login_btn_medium_narrow.png"}}),o.$fbLogin.on({click:r,mouseover:function(){this.src="/facebook_ov.png"},mouseout:function(){this.src="/facebook.png"}}),o.$localhost.click(e),o.$localhost2.click(n)};return{initModule:l}}(),wwm.modal=function(){function o(o){r={$con:o,$close:o.find(".modal-close"),$title:o.find("#room-title"),$limit:o.find("#room-people-limit"),$password:o.find("#room-password"),$createRoom:o.find("#create-room-btn")}}function e(o){o.preventDefault(),wwm.shell.modal.hide()}function n(o){o.preventDefault();var e=(new Spinner).spin();r.$con.append(e.el);var n=r.$title.val().trim(),i=r.$limit.val(),t=r.$password.val().trim()||null,l=userInfo.id.toString(),a=userInfo.picture;if(!n)return $(e.el).remove(),void alert("제목을 입력하세요.");var s={rid:(new Date).getTime().toString(),title:n,maker:l,limit:i,picture:a,password:t,members:JSON.stringify([{id:userInfo.id,name:userInfo.name,picture:userInfo.picture,confirm:!1}])};console.log("createroom data",s);var d=wwm.model.createRoom(s);d.done(function(o){console.log(o),s.current=1,wwm.room.initModule(s,"create"),wwm.shell.modal.hide()}),d.fail(function(o){console.log(o),alert("방 생성에러! 콘솔확인")}),d.always(function(){$(e.el).remove()})}function i(i){wwm.shell.modal.html(i),o(wwm.shell.modal),wwm.shell.modal.fadeIn("slow"),r.$close.click(e),r.$createRoom.click(n)}var r;return{initModule:i}}(),wwm.room=function(){var o,e={now:"day",dayArray:null,nightArray:null,memberList:[],myInfo:{id:null,name:null,confirm:!1,personColor:0},onlineList:new Array(8),maker:0,rid:null,title:null,limit:0,current:0},n={colorList:["red","orange","yellow","yellowgreen","skyblue","purple","violet","pink"]},i=io(),r=function(e){o={$con:e,$calendar:e.find("table"),$dayTable:e.find("#day-table"),$nightTable:e.find("#night-table"),$thDay:e.find("#day-table, #night-table").find("tr").eq(0).find("th"),$thTime:e.find("#day-table, #night-table").find("tr").find("th:first-child"),$memberList:e.find("#member-list"),$toggleCalendar:e.find("#toggle-table"),$toLobby:e.find("#back-to-lobby"),$quit:e.find("#quit"),$myMenu:e.find("#my-menu"),$admin:e.find("#manage-btn, #invite-btn"),$dayExp:e.find("#day-exc-btn"),$notDay:e.find("#day-exception").find("li"),$timeExp:e.find("#time-exc-btn"),$notTime:e.find("#time-exception").find("li"),$explode:e.find("#explode-room"),$ban:e.find("#ban-people-btn"),$banList:e.find("#ban-member-list"),$changeLimit:e.find("#change-limit-btn"),$changeTitle:e.find("#change-room-title"),$title:e.find("#title"),$current:e.find("#current-number"),$limit:e.find("#limit-number"),$sendChat:e.find("#send-chat"),$chatList:e.find("#chat-list"),$confirm:e.find("#confirm-calendar"),$refresh:e.find("#refresh-calendar"),$allConfirmed:e.find("#all-confirmed"),$kakaoInvite:e.find("#kakao-invite"),$fbInvite:e.find("#fb-invite"),$aside:e.find("#room-aside"),$toggleAside:e.find("#show-aside, #close-aside")}},t=function(o){var e=new Array(o||0),n=o,i=0;if(arguments.length>1)for(var r=Array.prototype.slice.call(arguments,1);n--;)e[o-1-n]=t.apply(this,r);if(1==arguments.length)for(i;i<e.length;i++)e[i]=[];return e},l=function(o){console.log("tableToArray");for(var e=[],n=0;n<o.length;n++){var i=o[n],r=[i.parentNode.rowIndex-1,i.cellIndex-1];e.push(r)}return console.log("tableToArray",e),e},a=function(i,r,t,l){console.log("arrayTotable",i,r,t,l);var a,s,d,c,m,f,u;if("day"===t){for(a=0;a<i.length;a++){d=i[a],m=o.$dayTable.find("tr").eq(d[0]+1).find("td").eq(d[1]);var g=e.dayArray[d[0]][d[1]];if(l){for(g.push(r),c=g.length,m.find("div").remove(),f=$("<div/>").addClass("box-"+c),s=0;c>s;s++)f.append($("<div/>",{"class":n.colorList[g[s]]}));f.appendTo(m)}else{for(u=g.indexOf(r),u>-1&&g.splice(u,1),c=g.length,m.find("div").remove(),f=$("<div/>").addClass("box-"+c),s=0;c>s;s++)console.log(n.colorList[g[s]]),f.append($("<div/>",{"class":n.colorList[g[s]]}));f.appendTo(m)}e.dayArray[d[0]][d[1]]=g}console.log("arrToTable:day",e.dayArray,e.nightArray)}else if("night"===t){for(a=0;a<i.length;a++){d=i[a],m=o.$nightTable.find("tr").eq(d[0]+1).find("td").eq(d[1]);var h=e.nightArray[d[0]][d[1]];if(l){for(h.push(r),c=h.length,m.find("div").remove(),f=$("<div/>").addClass("box-"+c),s=0;c>s;s++)f.append($("<div/>",{"class":n.colorList[h[s]]}));f.appendTo(m)}else{for(u=h.indexOf(r),u>-1&&h.splice(u,1),c=h.length,m.find("div").remove(),f=$("<div/>").addClass("box-"+c),s=0;c>s;s++)f.append($("<div/>",{"class":n.colorList[h[s]]}));f.appendTo(m)}e.nightArray[d[0]][d[1]]=h}console.log("arrToTable:night",e.dayArray,e.nightArray)}},s=function(){var i,r,t,l,a,s;for(i=0;12>i;i++)for(r=0;7>r;r++){l=o.$dayTable.find("tr").eq(i+1).find("td").eq(r);var d=e.dayArray[i][r];if(a=d.length,l.find("div").remove(),console.log(l,d,a),a>0){for(s=$("<div/>").addClass("box-"+a),t=0;a>t;t++)s.append($("<div/>",{"class":n.colorList[d[t]]}));s.appendTo(l)}}for(i=0;12>i;i++)for(r=0;7>r;r++){l=o.$nightTable.find("tr").eq(i+1).find("td").eq(r);var c=e.nightArray[i][r];if(a=c.length,l.find("div").remove(),a>0){for(s=$("<div/>").addClass("box-"+a),t=0;a>t;t++)s.append($("<div/>",{"class":n.colorList[c[t]]}));s.appendTo(l)}}},d=function(){console.log("showMembers",e.memberList),o.$memberList.find("ul").empty();for(var i=$("#wwm-member-list").html(),r=0;r<e.memberList.length;r++){var t=e.memberList[r];dust.render(dust.loadSource(dust.compile(i)),{id:t.id,color:n.colorList[r],name:t.name,picture:t.picture},function(e,n){e?o.$memberList.find("ul").html(e):o.$memberList.find("ul").append(n)})}m()},c=function(n){console.log("newMember",n,n.id,e.memberList);var i=$("#wwm-member-list").html();e.memberList.push({id:n.id,name:n.name,picture:n.picture,confirm:!1}),o.$banList.append('<option value="'+n.id+'">'+f(n.id).name+"</option>"),dust.render(dust.loadSource(dust.compile(i)),{id:n.id,color:f(id).color,name:n.name,picture:n.picture},function(e,n){e?o.$memberList.find("ul").html(e):o.$memberList.find("ul").append(n)}),m()},m=function(){console.log("showOnline onlineList",e.onlineList);for(var n=0;n<e.memberList.length;n++){var i=o.$memberList.find("li").eq(n);e.onlineList[n]?0!==i.has(".offline").length&&i.find(".offline").toggleClass("offline online"):0!==i.has(".online").length&&i.find(".online").toggleClass("online offline")}},f=function(o){console.log("findInfo",o);for(var i={},r=0;r<e.memberList.length;r++)o==e.memberList[r].id&&(i.personColor=r,i.name=e.memberList[r].name,i.color=n.colorList[r]);return i},u=function(o){o.preventDefault();var n=$(this).prev().val();if(console.log("ban",n),n==e.maker)return void alert("자기 자신을 강퇴시키면 안 되겠죠?");var r=wwm.model.ban(n,o.data.rid);r.done(function(){i.emit("ban",{id:n,order:f(n).personColor})}),r.fail(function(o){console.log(o),alert("퇴장당하지 않으려고 버티는중! 다시 시도하세요.")})},g=function(n){n.preventDefault();var i=$(this).prev().val();console.log("changeTitle",i);var r=wwm.model.changeTitle(e.rid,i);r.done(function(){e.title=i,o.$title.text(i)}),r.fail(function(o){alert("제목 바꾸기 실패!"),console.log(o)})},h=function(o){o.preventDefault();var n=Number($(this).prev().val());if(n!==n)return void alert("숫자를 입력해야 합니다.");if(console.log("changeLiimit",n),n<e.current)return void alert("현재 사람이 설정한 수보다 많습니다.");var i=wwm.model.changeLimit(e.rid,n);i.done(function(){M(n)}),i.fail(function(o){alert("인원수 바꾸기 실패!"),console.log(o)})},p=function(){I(),console.log("onClickDay");var o,n=this.cellIndex-1;o="day"===e.now?e.dayArray:e.nightArray;for(var r=[],t=!0,l=0;12>l;l++)-1==o[l][n].indexOf(e.myInfo.personColor)&&(t=!1,r.push([l,n]));if(t){for(r=[],l=0;12>l;l++)r.push([l,n]);$(this).removeClass("selected"),i.emit("not-busy",{cur:e.now,sid:e.myInfo.personColor,arr:r})}else $(this).addClass("selected"),i.emit("busy",{cur:e.now,sid:e.myInfo.personColor,arr:r})},w=function(){I();var o=this.parentNode.rowIndex-1;console.log("onClickTime",o);var n;n="day"===e.now?e.dayArray:e.nightArray;var r=[],t=!0;console.log(n[o]);for(var l=0;7>l;l++)-1==n[o][l].indexOf(e.myInfo.personColor)&&(t=!1,r.push([o,l]));if(t){for(r=[],l=0;7>l;l++)r.push([o,l]);$(this).removeClass("selected"),i.emit("not-busy",{cur:e.now,sid:e.myInfo.personColor,arr:r})}else $(this).addClass("selected"),i.emit("busy",{cur:e.now,sid:e.myInfo.personColor,arr:r})},y=function(o){o.stopPropagation(),console.log("showAdminMenu");var e=$(this);e.parent().hasClass("opened")?e.parent().removeClass("opened"):($(".opened").removeClass("opened"),e.parent().addClass("opened"))},b=function(o){o.stopPropagation(),console.log("showDayException");var e=$(this);e.parent().hasClass("opened")?e.parent().removeClass("opened"):($(".opened").removeClass("opened"),e.parent().addClass("opened"))},v=function(o){o.stopPropagation(),console.log("showTimeexception");var e=$(this);e.parent().hasClass("opened")?e.parent().removeClass("opened"):($(".opened").removeClass("opened"),e.parent().addClass("opened"))},k=function(e){console.log("deleteRoom",e.data.rid);var n=e.data.rid,r=wwm.model.deleteRoom(n,userInfo.id);r.done(function(){alert("삭제되었습니다."),wwm.lobby.initModule(o.$con),i.emit("explode",n)}),r.fail(function(o){console.log(o),alert("방 지우기 오류발생")})},I=function(){o.$confirm.hasClass("confirmed")&&(alert("확정 상태가 해제됩니다."),o.$confirm.removeClass("confirmed"),e.myInfo.confirm=!1,i.emit("confirmed",{id:e.myInfo.id,bool:!1}))},L=function(){console.log("onclickCell",e.dayArray),I();var o,n;o="day"===e.now?e.dayArray:e.nightArray,n=o[this.parentNode.rowIndex-1][this.cellIndex-1],console.log(this.parentNode.rowIndex-1,this.cellIndex-1,n,n.length,e.myInfo.personColor),n?(console.log(n.length,n.indexOf(e.myInfo.personColor)>-1),n.length&&n.indexOf(e.myInfo.personColor)>-1?i.emit("not-busy",{cur:e.now,sid:e.myInfo.personColor,arr:l([this],!1)}):i.emit("busy",{cur:e.now,sid:e.myInfo.personColor,arr:l([this],!0)})):i.emit("busy",{cur:e.now,sid:e.myInfo.personColor,arr:l([this],!0)})},C=function(){I();var o=$(this).index();console.log("excludeDay",o);for(var n=[],r=0;12>r;r++)n.push([r,o]);$(this).hasClass("selected")?(i.emit("not-busy",{cur:"day",sid:e.myInfo.personColor,arr:n}),i.emit("not-busy",{cur:"night",sid:e.myInfo.personColor,arr:n}),$(this).removeClass("selected")):(i.emit("busy",{cur:"day",sid:e.myInfo.personColor,arr:n}),i.emit("busy",{cur:"night",sid:e.myInfo.personColor,arr:n}),$(this).addClass("selected"))},S=function(){I();var o,n,r=$(this).index(),t=$(this).find("input").val();if(console.log("excludeTime",r,t),t){var l=[];if(0===r){for(o=0;t>o;o++)for(n=0;7>n;n++)l.push([t,n]);console.log("arr",l),$(this).hasClass("selected")?(i.emit("not-busy",{cur:"day",sid:e.myInfo.personColor,arr:l}),i.emit("not-busy",{cur:"night",sid:e.myInfo.personColor,arr:l}),$(this).removeClass("selected")):(i.emit("busy",{cur:"day",sid:e.myInfo.personColor,arr:l}),i.emit("busy",{cur:"night",sid:e.myInfo.personColor,arr:l}),$(this).addClass("selected"))}else{for(o=t-1;12>o;o++)for(n=0;7>n;n++)console.log(l),l.push([t,n]);console.log("arr",l),$(this).hasClass("selected")?(i.emit("not-busy",{cur:"day",sid:e.myInfo.personColor,arr:l}),i.emit("not-busy",{cur:"night",sid:e.myInfo.personColor,arr:l}),$(this).removeClass("selected")):(i.emit("busy",{cur:"day",sid:e.myInfo.personColor,arr:l}),i.emit("busy",{cur:"night",sid:e.myInfo.personColor,arr:l}),$(this).addClass("selected"))}}},A=function(n){console.log("toLobby",n.data.rid),o.$confirm.hasClass("confirmed")?(history.pushState({mod:"lobby"},"","/lobby/"+e.myInfo.id),i.emit("out",{id:e.myInfo.id,rid:n.data.rid}),wwm.lobby.initModule(o.$con)):confirm("확정 버튼을 누르지 않고 나가면 저장되지 않은 사항은 사라집니다.")&&(history.pushState({mod:"lobby"},"","/lobby/"+e.myInfo.id),i.emit("out",{id:e.myInfo.id,rid:n.data.rid}),wwm.lobby.initModule(o.$con))},x=function(n){return console.log("quit",n.data.rid),1===e.current?void(confirm("혼자 있을 때 방을 나가면 방이 사라집니다.그래도 나가시겠습니까?")&&wwm.model.deleteRoom(n.data.rid,e.myInfo.id)):void(confirm("정말 나가시겠습니까? 잠시 나가는 거면 목록 버튼을 클릭하세요.")&&(history.replaceState({mod:"lobby"},"","/lobby/"+e.myInfo.id),i.emit("quit",{id:e.myInfo.id,rid:n.data.rid}),wwm.lobby.initModule(o.$con)))},T=function(n){console.log("changeCurrentNumber",n),e.current+=n,o.$current.text(e.current),$("#current-people-limit").val(e.current)},M=function(n){console.log("changeLimitNumber",n),e.limit=n,o.$limit.text(n)},_=function(o){o.preventDefault();var n=$(this).parent().prev().val();console.log("sendChat",e.myInfo.id,n),i.emit("chat",{id:e.myInfo.id,name:e.myInfo.name,text:n})},O=function(){console.log("refresh",{rid:e.rid,id:e.myInfo.id}),i.on("responseArr",function(o){console.log("socket responseArr"),e.dayArray=o.day,e.nightArray=o.night,s()}),i.emit("requestArr",{rid:e.rid,id:e.myInfo.id})},q=function(n){console.log("confirm",n.data);var r=n.data;r.bool=!e.myInfo.confirm,r.day=e.dayArray,r.night=e.nightArray,console.log("change confirm to",r.bool,e.dayArray,r.day,e.dayArray===r.day);var t=wwm.model.confirm(r);t.done(function(){o.$confirm.hasClass("confirmed")?o.$confirm.removeClass("confirmed"):o.$confirm.addClass("confirmed"),e.myInfo.confirm=r.bool,i.emit("confirmed",{id:e.myInfo.id,bool:r.bool}),console.log(e.dayArray)}),t.fail(function(o){console.log(o),alert("confirm error!")})},N=function(){"day"===e.now?(e.now="night",o.$dayTable.hide(),o.$nightTable.show()):(e.now="day",o.$dayTable.show(),o.$nightTable.hide()),$(this).find("div").toggleClass("tapped")},D=function(){console.log("toConfirmPage",e),history.pushState({mod:"confirm"},"","/result/"+e.rid),wwm.confirm.initModule(e)},j=function(){Kakao.Link.createTalkLinkButton({container:"#kakao-invite",label:"카카오링크 샘플에 오신 것을 환영합니다.",image:{src:"http://dn.api1.kage.kakao.co.kr/14/dn/btqaWmFftyx/tBbQPH764Maw2R6IBhXd6K/o.jpg",width:"300",height:"200"},webButton:{text:"우리 언제 만나",url:"http://whenwemeet.herokuapp.com"},fail:function(){alert("KakaoLink is currently only supported in iOS and Android platforms.")}})},F=function(){FB.ui({method:"send",link:"http%3A%2F%2Fwww.nytimes.com%2F2011%2F06%2F15%2Farts%2Fpeople-argue-just-to-win-scholars-assert.html"})},J=function(){console.log("toggleAside",o.$aside.hasClass("opened")),o.$aside.hasClass("opened")?(o.$aside.removeClass("opened"),o.$aside.css("left","-100%")):(o.$aside.addClass("opened"),o.$aside.css("left","0"))},R=function(n,l){console.log("room initModule",l),e.title=n.title,e.limit=Number(n.limit),e.rid=n.rid.toString(),e.maker=n.maker.toString(),console.log("entered room id"+e.rid),console.log("is doc.member array? "+Array.isArray(n.members)),"create"===l?(e.dayArray=t(12,7),e.nightArray=t(12,7)):"enter"===l&&(e.dayArray=n.day||t(12,7),e.nightArray=n.night||t(12,7)),e.memberList=Array.isArray(n.members)?n.members:JSON.parse(n.members),e.current=e.memberList.length,e.myInfo.id=userInfo.id.toString(),e.myInfo.name=userInfo.name;for(var I=0;I<e.memberList.length;I++)if(e.memberList[I].id==userInfo.id){e.myInfo.personColor=I,e.myInfo.confirm=e.memberList[I].confirm;break}e.onlineList[e.myInfo.personColor]=!0,console.log("onlineList",e.onlineList),i.emit("enter",{id:e.myInfo.id,rid:e.rid,name:e.myInfo.name,color:e.myInfo.personColor,picture:userInfo.picture});var M={name:e.myInfo.name,title:e.title,current:e.current,limit:e.limit,members:e.memberList};e.myInfo.id==e.maker&&(M.admin=!0),console.log("admin?",e.myInfo.id==e.maker);var R=$("#wwm-room").text();dust.render(dust.loadSource(dust.compile(R)),M,function(n,t){if(n)return void wwm.shell.view.html(n);wwm.shell.view.html(t),r(wwm.shell.view),s(),e.myInfo.confirm&&o.$confirm.addClass("confirmed");for(var l=0,$=0;$<e.memberList.length;$++)console.log(e.memberList[$].confirm===!0,e.memberList[$].confirm),e.memberList[$].confirm===!0&&l++;console.log(l===e.memberList.length,l,e.memberList.length),l===e.memberList.length?o.$allConfirmed.show():o.$allConfirmed.hide(),d(),i.on("out",function(n){console.log(o.$memberList,o.$memberList.find("[data-id="+n+"]"));for(var i=0;i<e.memberList.length;i++)if(e.memberList[i].id==n){e.onlineList[i]=!1;break}m(),console.log("socketout",e.onlineList,e.memberList)}),i.on("quit",function(n){for(var i=0;i<e.memberList.length;i++)if(e.memberList[i].id==n){e.onlineList.splice(i,1),e.memberList.splice(i,1);break}console.log(o.$memberList,o.$memberList.find("[data-id="+n+"]")),o.$banList.find("[value="+n+"]").remove(),T(-1),d(),console.log("socketquit",e.onlineList,e.memberList)}),i.on("newMember",function(o){console.log("socket newmember",o),e.onlineList[o.color]=!0,i.emit("uptodateArr",{sid:o.socket,day:e.dayArray,night:e.nightArray,online:e.onlineList}),o.color>=e.current&&(T(1),c(o)),m()}),i.on("uptodateArr",function(o){console.log("socket uptodateArr"),e.dayArray=o.day,e.nightArray=o.night,e.onlineList=o.online,m(),s()}),i.on("chat",function(e){console.log("socket chat",e.id,e.text),o.$chatList.append("<p>"+e.name+": "+e.text+"<]>")}),i.on("busy",function(o){console.log("socketbusy:",o.arr,o.sid,o.cur),a(o.arr,o.sid,o.cur,!0)}),i.on("not-busy",function(o){console.log("socketnotbusy:",o.arr,o.sid,o.cur),a(o.arr,o.sid,o.cur,!1)}),i.on("requestArr",function(o){console.log("socket requestArr"),i.emit("responseArr",{sid:o.sid,day:e.dayArray,night:e.nightArray})}),i.on("ban",function(n){if(e.myInfo.personColor==n.order)return alert("강퇴당하셨습니다..."),void wwm.lobby.initModule(o.$con);e.myInfo.personColor>n.order&&e.myInfo.personColor--,
alert(f(id).name+"님이 강제퇴장 되었습니다. 잘가요!");for(var i=0;i<e.memberList.length;i++)if(n.id==e.memberList[i].id){e.memberList.splice(i,1),e.onlineList.splice(i,1);break}T(-1),o.$banList.find("option").eq(n.order).remove(),d(),console.log("socket ban")}),i.on("confirmed",function(n){for(var i=0,r=0;r<e.memberList.length;r++)e.memberList[r].id==n.id&&(e.memberList[r].confirm=n.bool),e.memberList[r].confirm===!0&&i++;i==e.memberList.length?o.$allConfirmed.show():o.$allConfirmed.hide(),console.log("socket confirmed")}),i.on("explode",function(){alert("방이 폭파되었습니다. 로비로 이동합니다."),wwm.lobby.initModule(o.$con),console.log("socket explode")}),o.$calendar.find("td").click(L),o.$explode.click({id:e.rid},k),o.$toLobby.click({rid:e.rid},A),o.$toggleCalendar.click(N),o.$admin.click(y),o.$dayExp.click(b),o.$timeExp.click(v),o.$ban.click({rid:e.rid},u),o.$changeLimit.click({id:e.rid},h),o.$changeTitle.click({id:e.rid},g),o.$sendChat.click(_),o.$notDay.click(C),o.$notTime.click(S),o.$thDay.click(p),o.$thTime.click(w),o.$confirm.click({id:e.myInfo.id,rid:e.rid},q),o.$refresh.click(O),o.$allConfirmed.click(D),o.$quit.click({id:e.myInfo.id,rid:e.rid},x),o.$toggleAside.click(J),o.$kakaoInvite.on({click:j,mouseover:function(){this.src="/kakaolink_btn_medium_ov.png"},mouseout:function(){this.src="/kakaolink_btn_medium.png"}}),o.$fbInvite.on({click:F,mouseover:function(){this.src="/facebook_invite_ov.png"},mouseout:function(){this.src="/facebook_invite.png"}})})};return{initModule:R,info:e}}();